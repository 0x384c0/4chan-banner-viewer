function updatePosts(e){Post(window.thread.id).download(function(t){if(t.hasOwnProperty("error"))return e&&e(t);if(!t.list.length)return e&&e({updated:0,list:[],data:[],favorites:t.favorites});var a=Post(1);$.each(t.list,function(e,t){a.num=t,appendPost(a.getJSON()),a.raw().rendered=!0}),Store.get("other.fav_stats",!1)&&t.favorites&&$("#loice-bar"+window.thread.id).html(t.favorites).removeClass("loice-bar-empty").show(),e&&e(t)})}function generatePostBody(e){e.comment=e.comment.replace("<script ","<!--<textarea "),e.comment=e.comment.replace("</script>","</textarea>-->");var t="",a=Post(e.num).getReplyLinks();switch(t+='<div id="post-details-'+e.num+'" class="post-details">',t+='<input type="checkbox" name="delete"  class="turnmeoff" value="'+e.num+'" /> ',e.subject&&(t+='<span class="post-title">',t+=e.subject,t+="</span> "),t+=e.email?'<a href="'+e.email+'" class="post-email">'+e.name+"</a> ":'<span class="ananimas">'+e.name+"</span> ",e.icon&&(t+='<span class="post-icon">'+e.icon+"</span>"),e.trip){case"!!%adm%!!":t+='<span class="adm">## Abu ##</span>';break;case"!!%mod%!!":t+='<span class="mod">## Mod ##</span>';break;case"!!%Inquisitor%!!":t+='<span class="inquisitor">## Applejack ##</span>';break;case"!!%coder%!!":t+='<span class="mod">## Кодер ##</span>';break;default:t+='<span class="postertrip">'+e.trip+"</span>"}if(1==e.op&&(t+='		<span class="ophui"># OP</span>&nbsp;'),t+='	<span class="posttime">'+(window.correctTZ?window.correctTZ(e.date):e.date)+"&nbsp;</span>",t+='	<span class="reflink">',t+='<a href="/'+window.thread.board+"/res/"+e.parent+".html#"+e.num+'">№</a>',t+='<a href="/'+window.thread.board+"/res/"+e.parent+".html#"+e.num+'" class="postbtn-reply-href" name="'+e.num+'">'+e.num+"</a>",t+='		<span class="postpanel">',t+='          <span data-num="'+e.num+'" class="postbtn-options" title="Опции поста"></span>',t+='			<a class="postbtn-adm" style="display:none" href="#" onclick="addAdminMenu(this); return false;" onmouseout="removeAdminMenu(event); return false;"></a>',t+="		</span>",t+="	</span>",t+='	<br class="turnmeoff" />',t+="</div>",t+='<div class="images '+(e.files&&1==e.files.length?"images-single":"")+'">',e.files)for(var r=e.files.length,n=0;r>n;n++){var i=e.files[n],o=".webm"==i.name.substr(-5);t+='			<figure class="image">',t+='				<figcaption class="file-attr">',t+='					<a class="desktop" target="_blank" href="/'+window.thread.board+"/"+i.path+'">'+i.name+"</a>",o&&(t+='      <img src="/makaba/templates/img/webm-logo.png" width="50px" alt="webm file" id="webm-icon-'+e.num+"-"+i.md5+'"> '),t+='					<span class="filesize">('+i.size+"Кб, "+i.width+"x"+i.height+")</span>",t+="				</figcaption>",t+="				",t+='				<div id="exlink-'+e.num+"-"+i.md5+'">',t+='					<a href="/'+window.thread.board+"/"+i.path+'" name="expandfunc" onclick="expand(\''+e.num+"-"+i.md5+"','/"+window.thread.board+"/"+i.path+"','/"+window.thread.board+"/"+i.thumbnail+"',"+i.width+","+i.height+","+i.tn_width+","+i.tn_height+'); return false;">',t+='						<img src="/'+window.thread.board+"/"+i.thumbnail+'" width="'+i.tn_width+'" height="'+i.tn_height+'" alt="'+i.size+'" class="img preview'+(o?" webm-file":"")+'" />',t+="					</a>",t+="				</div>",t+="			</figure>"}else e.video&&(t+='		<div style="float: left; margin: 5px; margin-right:10px">',t+="			"+e.video,t+="		</div>");return t+="</div>",t+='<blockquote id="m'+e.num+'" class="post-message">',t+=e.comment,1==e.banned?t+='			<br/><span class="pomyanem">(Автор этого поста был забанен. Помянем.)</span>':2==e.banned&&(t+='	<br/><span class="pomyanem">(Автор этого поста был предупрежден.)</span>'),t+="</blockquote>",t+='<div id="refmap-'+e.num+'" class="ABU-refmap" style="'+(a?"":"display: none;")+'"><em>Ответы: </em>'+a+"</div>"}function appendPost(e){if(!e.hasOwnProperty("num"))return!1;if($("#post-"+e.num).length)return!1;var t="";return t+='<div id="post-'+e.num+'" class="post-wrapper">',t+='<div class="reply post" id="post-body-'+e.num+'" data-num="'+e.num+'">',t+=generatePostBody(e),t+="</div>",t+="</div>",$(".thread").append(t),Media.processLinks($("#post-"+e.num+" a")),!0}function updateThread(){$alert("Загрузка...","wait"),updatePosts(function(e){$close($id("ABU-alert-wait")),e.updated?$alert("Новых постов: "+e.updated):e.error?$alert("Ошибка: "+e.errorText):$alert("Нет новых постов"),Favorites.isFavorited(window.thread.id)&&Favorites.setLastPost(e.data,window.thread.id)})}function requestCaptchaKeyGoogle(e){var t=get_cookie("usercode"),a="/makaba/captcha.fcgi?type=recaptcha";t&&(a+="&usercode="+t);var r=!1,n=setTimeout(function(){r=!0,e&&e("Превышен интервал ожидания")},window.config.loadCaptchaTimeout);$.get(a,function(t){return r?!1:(clearTimeout(n),e(0==t.indexOf("VIPFAIL")?"VIPFAIL":0==t.indexOf("VIP")?"VIP":0==t.indexOf("SQLFAIL")?"SQLFAIL":0==t.indexOf("CHECK")?{key:t.substr(6)}:t))}).fail(function(t,a){return r?!1:(clearTimeout(n),void(e&&e(a)))})}function loadCaptchaGoogle(){requestCaptchaKey(function(e){e.key?($(".captcha-key").val(e.key),$("#captcha-value,#qr-captcha-value").val(""),""==$("#captcha-widget").html()?(widgetQr=grecaptcha.render("captcha-widget",{sitekey:e.key,theme:"light"}),console.log("html"+$("#captcha-widget").html())):(grecaptcha.reset(widgetQr),console.log("reset widgetQr"+$("#captcha-widget").html())),""==$("#captcha-widget-main").html()?widgetMain=grecaptcha.render("captcha-widget-main",{sitekey:e.key}):(grecaptcha.reset(widgetMain),console.log("reset widgetMain"+$("#captcha-widget").html()))):"VIP"==e?$(".captcha-box").html("Вам не нужно вводить капчу, у вас введен пасс-код."):"VIPFAIL"==e?$(".captcha-box").html("Ваш пасс-код не действителен, пожалуйста, перелогиньтесь."):$(".captcha-image").html(e)})}function requestCaptchaKeyYandex(e){var t=get_cookie("usercode"),a="/makaba/captcha.fcgi";t&&(a+="?usercode="+t);var r=!1,n=setTimeout(function(){r=!0,e&&e("Превышен интервал ожидания")},window.config.loadCaptchaTimeout);$.get(a,function(t){return r?!1:(clearTimeout(n),e(0==t.indexOf("VIPFAIL")?"VIPFAIL":0==t.indexOf("VIP")?"VIP":0==t.indexOf("SQLFAIL")?"SQLFAIL":0==t.indexOf("CHECK")?{key:t.substr(6)}:t))}).fail(function(t,a){return r?!1:(clearTimeout(n),void(e&&e(a)))})}function loadCaptchaYandex(){$(".captcha-image").html("Загрузка..."),requestCaptchaKey(function(e){e.key?($(".captcha-image").html('<img src="//captcha.yandex.net/image?key='+e.key+'">'),$(".captcha-key").val(e.key),$("#captcha-value,#qr-captcha-value").val("")):"VIP"==e?$(".captcha-box").html("Вам не нужно вводить капчу, у вас введен пасс-код."):"VIPFAIL"==e?$(".captcha-box").html("Ваш пасс-код не действителен, пожалуйста, перелогиньтесь."):$(".captcha-image").html(e)})}function showQrForm(e){e||(e=$("#qr")),Store.get("styling.qr.disable",!1)||Store.get("styling.qr.disable_if_postform",!1)&&$("#postform").is(":visible")||(e.show(),loadCaptcha())}function insert(e){var t=window.activeForm,a=t[0],r=$("#qr-shampoo"),n=r[0],i=$("#qr"),o=$(window);if(i.is(":visible")||(o.width()>=768&&o.height()>=480||!Store.get("mobile.hide_qr",!0))&&showQrForm(i),document.selection){n.focus();var s=document.selection.createRange();s.text=e,n.focus()}else if(a.selectionStart||"0"==a.selectionStart){var d=a.selectionStart;a.selectionStart=0,n.value=a.value.substring(0,d)+e+a.value.substring(d),n.focus(),n.selectionStart=d+e.length,n.selectionEnd=d+e.length}else n.value+=e,n.focus();r.keyup()}function getTimeInDays(){return Math.ceil(+new Date/1e3/60/60/24)}function renderStore(){$("#name").val(Store.get("thread.postform.name",""));var e=Store.get("thread.postform.email","");$("#qr-e-mail,#e-mail").val(e),$("#sagecheckbox").prop("checked","sage"==e);var t=!!Store.get("thread.postform.watermark",!1);$("#makewatermark").prop("checked",t);var a=Store.get("thread.postform.icon."+window.thread.board,!1);if(a&&$(".anoniconsselectlist").val(a),!window.thread.id)return!1;var r=!!Store.get("thread.autorefresh",!1),n=$(".autorefresh-checkbox");n.prop("checked",r),r&&autorefresh_start()}function expandThread(e,t){var a=Post(e),r=a.threadPosts(),n=$("#expanded-posts"+e),i=function(){var a=Post(1),n=$("#thread-"+e),i=$('<span id="expanded-posts'+e+'"></span>'),o=n.find(".post-wrapper"),s=o.length;n.append(i);for(var d=0;d<r.length;d++)if(a.num=r[d],!a.isThread()&&!a.isNotFound())if(a.isRendered())i.append(a.el());else{var l;l='<div id="post-'+a.num+'" class="post-wrapper">',l+='<div class="reply post" id="post-body-'+a.num+'" data-num="'+a.num+'">',l+=generatePostBody(a.getJSON()),l+="</div>",l+="</div>",i.append(l),Media.processLinks($("#post-"+a.num+" a"));var c=a.raw();c.rendered=!0}var h=i.find(".post-wrapper").slice(-s);n.append(h),n.find(".mess-post, .mess-post-mob").remove(),t&&t()};return n.length?n.toggle():void(a.isThreadPreloaded()?i():($alert("Загрузка...","wait"),a.download(function(e){return $close($id("ABU-alert-wait")),e.hasOwnProperty("errorText")?$alert("Ошибка: "+e.errorText):void i()})))}function scrollToPost(e){$(document).scrollTop($("#post-"+e).offset().top)}function escapeHTML(e){return(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function draggable_qr(e,t){var a=!1,r=0,n=0,i=0,o=0,s=$("#"+e),d=0,l=0,c=function(e,t){var a=$(window),r=a.width(),n=a.height(),i=s.innerWidth(),o=s.innerHeight();e+i>r&&(e=r-i),t+o>n&&(t=n-o),0>e&&(e=0),0>t&&(t=0),s.css("top",t+"px"),s.css("left",e+"px"),d=e,l=t};$("#"+e+"-header").mousedown(function(e){e.preventDefault();var t=$(window);r=e.pageX-t.scrollLeft(),n=e.pageY-t.scrollTop(),i=r-d,o=n-l,a=!0}),$(document).mousemove(function(e){if(a){var t=$(window),s=e.pageX-t.scrollLeft(),d=e.pageY-t.scrollTop();r=s,n=d,c(s-i,d-o)}}),$(document).mouseup(function(){a&&(Store.set("styling."+e+".x",d),Store.set("styling."+e+".y",l),a=!1)}),$(window).resize(function(){c(d,l)});var h=$(window);$(function(){var a=Store.get("styling."+e+".x",!1),r=Store.get("styling."+e+".y",!1);"number"==typeof a&&"number"==typeof r?c(a,r):"center"==t?c((h.width()-s.width())/2,Math.floor(h.height()/3-s.height()/2)):c(h.width()-s.width(),Math.floor(h.height()/3-s.height()/2))})}function draggable(e,t){var a,r,n=!1,i=0,o=$(window);e.mousedown(function(e){1==e.which&&(t&&t.mousedown&&t.mousedown(e.clientX,e.clientY)===!1||(e.preventDefault(),n=!0,i=0,a=e.clientX,r=e.clientY))}),o.mousemove(function(t){var o,s,d,l;n&&(o=t.clientX-a,s=t.clientY-r,i+=Math.abs(o)+Math.abs(s),a=t.clientX,r=t.clientY,d=parseInt(e.css("top")),l=parseInt(e.css("left")),e.css({top:d+s+"px",left:l+o+"px"}))}),o.mouseup(function(e){n&&(n=!1,6>i&&t&&t.click&&t.click(a,r))})}function pad(e,t){for(var a=e+"";a.length<t;)a="0"+a;return a}function getReadableFileSizeString(e){var t=-1,a=["Кб","Мб","GB","TB","PB","EB","ZB","YB"];do e/=1024,t++;while(e>1024);return Math.max(e,.1).toFixed(1)+a[t]}!function(){window.config={},window.config.autoUpdate={},window.config.favorites={},window.thread={},window.threadstats={},window.config.loadCaptchaTimeout=3e4,window.config.updatePostsTimeout=3e4,window.config.autoUpdate.minInterval=10,window.config.autoUpdate.maxInterval=30,window.config.autoUpdate.stepInterval=5,window.config.autoUpdate.faviconDefault='<link id="favicon" rel="shortcut icon" href="/favicon.ico"/>',window.config.autoUpdate.faviconNewposts='<link id="favicon" rel="shortcut icon" href="/makaba/templates/img/favicon_newposts.ico"/>',window.config.autoUpdate.faviconDeleted='<link id="favicon" rel="shortcut icon" href="/makaba/templates/img/favicon_deleted.ico"/>',window.config.favorites.interval_min=15,window.config.favorites.interval_max=43200,window.config.favorites.interval_multiplier=2,window.config.favorites.interval_error=120,window.config.favorites.interval_del_recheck=600,window.config.favorites.interval_lock=300,window.config.title=document.title,window.config.twitter_autoexpand=4,window.config.styles={makaba:!1,futaba:"/makaba/templates/css/futaba.css",burichan:"/makaba/templates/css/burichan.css",muon:"/makaba/templates/css/muon.css",neutron:"/makaba/templates/css/neutron.css",gurochan:"/makaba/templates/css/gurochan.css",konsole:"/makaba/templates/css/konsole.css"},window.threadstats.refresh=60,window.threadstats.retry=10,window.threadstats.request_timeout=3e4,window.threadstats.count=10,window.tz_offset=3}(),window.Store={memory:{},type:null,init:function(){this.html5_available()?(this.type="html5",this.html5_load()):this.cookie_available()&&(this.type="cookie",this.cookie_load())},get:function(e,t){var a=this.parse_path(e);if(!a)return t;for(var r=this.memory,n=a.length,i=0;n-1>i;i++){var o=a[i];if(!r.hasOwnProperty(o))return t;r=r[o]}var s=r[a[i]];return"undefined"==typeof s?t:s},set:function(e,t){if("undefined"==typeof t)return!1;this.type&&this[this.type+"_load"]();var a=this.parse_path(e);if(!a)return!1;for(var r=this.memory,n=a.length,i=0;n-1>i;i++){var o=a[i];if(r.hasOwnProperty(o)||(r[o]={}),r=r[o],"object"!=typeof r)return!1}return r[a[i]]=t,this.type&&this[this.type+"_save"](),!0},del:function(e){var t=this.parse_path(e);if(!t)return!1;this.type&&this[this.type+"_load"]();var a,r,n=this.memory,i=t.length;for(r=0;i-1>r;r++){if(a=t[r],!n.hasOwnProperty(a))return!1;n=n[a]}return n.hasOwnProperty(t[r])&&delete n[t[r]],this.cleanup(t),this.type&&this[this.type+"_save"](),!0},cleanup:function(e){var t,a=this.memory,r=[this.memory],n=e.length;for(t=0;n-2>t;t++){var i=e[t];a=a[i],r.push(a)}for(t=n-2;t>=0;t--){var o=r[t],s=e[t],d=!0;if($.each(o[s],function(){return d=!1,!1}),!d)return!0;delete o[s]}},reload:function(){this.type&&this[this.type+"_load"]()},"export":function(){return JSON.stringify(this.memory)},"import":function(e){try{return this.memory=JSON.parse(e),this.type&&this[this.type+"_save"](),!0}catch(t){return!1}},parse_path:function(e){var t=e.match(/[a-zA-Z0-9_\-\.]+/);return null==t?!1:t.hasOwnProperty("0")?t[0]!=e?!1:e.split("."):!1},html5_available:function(){if(!window.Storage)return!1;if(!window.localStorage)return!1;try{return localStorage.__storage_test="wU1vJ0p3prU1","wU1vJ0p3prU1"!=localStorage.__storage_test?!1:(localStorage.removeItem("__storage_test"),!0)}catch(e){return!1}},html5_load:function(){localStorage.store&&(this.memory=JSON.parse(localStorage.store))},html5_save:function(){localStorage.store=JSON.stringify(this.memory)},cookie_available:function(){try{return $.cookie("__storage_test","wU1vJ0p3prU1"),"wU1vJ0p3prU1"!=$.cookie("__storage_test")?!1:($.removeCookie("__storage_test"),!0)}catch(e){return!1}},cookie_load:function(){var e=$.cookie("store");e&&(this.memory=JSON.parse(e))},cookie_save:function(){var e=JSON.stringify(this.memory);$.cookie("store",e,1825)}},window.Media={processors:[],generators:{},unloaders:{},thumbnailers:{},add:function(e,t,a,r){var n=new RegExp(a,"i");this.processors.push([e,t,n,r])},addGenerator:function(e,t){this.generators[e]=t},addUnloader:function(e,t){this.unloaders[e]=t},addThumbnailer:function(e,t){this.thumbnailers[e]=t},parse:function(e){for(var t,a=this.processors.length,r=0;a>r;r++){var n=this.processors[r];if(!(e.indexOf(n[1])<0)&&(t=this.getValues(e,n)))break}return t},getValues:function(e,t){var a=t[0],r=t[2],n=t[3],i={type:a},o=r.exec(e);if(!o)return!1;for(var s in n)if(n.hasOwnProperty(s)){if(!o.hasOwnProperty(n[s]))return!1;i[s]=o[n[s]]}return i},getEmbedCode:function(e,t,a){this.generators[e]({id:t},a)},processLinks:function(e){e.each(function(){var e=$(this),t=e.text(),a=Media.parse(t);if(a){var r=e.closest(".post"),n=$('<span href="#" class="media-expand-button">[РАСКРЫТЬ]</span>'),i=$('<span href="#" class="media-hide-button">[ЗАКРЫТЬ]</span>'),o=$('<span class="media-expand-loading">[Загрузка...]</span>');if(Media.thumbnailers.hasOwnProperty(a.type)&&Store.get("old.media_thumbnails",!0)){var s=Store.get("old.media_thumbnails_on_hover",!0),d=$('<div class="media-thumbnail" '+(s?'style="display:none"':"")+">"+Media.thumbnailers[a.type](a)+"</div>"),l=$("#media-thumbnail");s?(e.hover(function(e){l.append(d).css({position:"absolute",display:"block","z-index":"999",top:e.pageY+"px",left:e.pageX+"px"}),d.show()}),e.mouseout(function(){d.hide(),l.hide()}),e.mousemove(function(e){l.css({top:e.pageY-10+"px",left:e.pageX+30+"px"})})):n.append(d)}e.after(n),n.click(function(){n.hide(),n.after(o);var t=r.data("expanded-media-count")||0;return t++,r.data("expanded-media-count",t),1==t&&window.kostyl_class&&r.addClass("expanded-media"),Media.getEmbedCode(a.type,a.id,function(t){if(o.remove(),!t)return n.show();var s=$("<br>"+t+"<br>");return e.after(s),e.after(i),i.click(function(){s.remove(),i.remove(),n.show(),Media.unloaders.hasOwnProperty(a.type)&&Media.unloaders[a.type](e);var t=r.data("expanded-media-count");return t--,r.data("expanded-media-count",t),0==t&&window.kostyl_class&&r.removeClass("expanded-media"),!1}),!1}),!1}),"twitter"==a.type&&window.config.twitter_autoexpand-- >0&&n.click()}})}},window.Favorites={timer:0,current:null,busy:!1,visible:!1,gevent_num:!1,gevent:!1,isFavorited:function(e){return!!Store.get("favorites."+e,!1)},remove:function(e){if(!this.isFavorited(e))throw new Error("Вызов Favorites.remove("+e+") для несуществующего треда");Store.del("favorites."+e),this.busy||this.reset(),this.render_remove(e),Gevent.emit("fav.remove",e)},add:function(e){if(this.isFavorited(e))throw new Error("Вызов Favorites.add("+e+") для существующего треда");var t=Post(e),a=t.getTitle(),r=t.last().num,n={board:window.thread.board,title:a,last_post:r,next_check:Math.floor(+new Date/1e3)+window.config.favorites.interval_min,last_interval:window.config.favorites.interval_min};Store.set("favorites."+e,n),this.render_add(e,n),Gevent.emit("fav.add",[e,n]),window.thread.id||this.reset()},reset:function(){this.resetCurrent(),this.current&&this.timerRestart(),this.busy=!1},timerStop:function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},timerRestart:function(){this.timerStop();var e,t=Math.floor(+new Date/1e3),a=this.getCurrent().next_check-t,r=this;e=1>a?1:1e3*a,this.timer=setTimeout(function(){r.preExecuteCheck()},e)},getCurrent:function(){return Store.get("favorites."+this.current,!1)},resetCurrent:function(){this.current=null;var e=Store.get("favorites",{}),t=Store.get("favorites.deleted_behavior",2);for(var a in e)if(e.hasOwnProperty(a)&&a!=window.thread.id&&e[a].hasOwnProperty("next_check")&&!this.isLocked(a)&&(!this.current||e[this.current].next_check>e[a].next_check)){if(e[a].deleted&&0==t)continue;this.current=a}},preExecuteCheck:function(){var e=this;this.busy=!0,this.render_refreshing(this.current),Gevent.onceNtemp("fav.abortExec"+this.current,1e3,function(){e.setNextCheck(e.current,window.config.favorites.interval_lock),e.render_refreshing_done(e.current),e.reset()},function(){e.executeCheck()}),Gevent.emit("fav.preExecuteCheck",this.current)},executeCheck:function(){var e=this.getCurrent().next_check,t=this.current;if(Store.reload(),this.isLocked()||e!=this.getCurrent().next_check)return this.render_refreshing_done(t),this.reset();this.lock();var a=this.getCurrent(),r={thread:this.current,from_post:a.last_post+1,board:a.board},n=this;Post(1)._fetchPosts(r,function(e){return e.hasOwnProperty("error")?"server"==e.error&&-404==e.errorCode?n.deleted(n.current):n.setNextCheck(n.current,window.config.favorites.interval_error):e.data.length?(n.setNewPosts(e.data.length),n.setLastPost(e.data),n.setNextCheck(n.current,window.config.favorites.interval_min),Store.get("favorites.show_on_new",!0)&&n.show()):n.setNextCheck(n.current,a.last_interval*window.config.favorites.interval_multiplier),n.unlock(),n.render_refreshing_done(n.current),n.reset()})},setNextCheck:function(e,t){var a=Store.get("favorites."+e);t<window.config.favorites.interval_min&&(t=window.config.favorites.interval_min),t>window.config.favorites.interval_max&&(t=window.config.favorites.interval_max),a.next_check=Math.floor(+new Date/1e3)+t,a.last_interval=t,Store.set("favorites."+e+".next_check",a.next_check),Store.set("favorites."+e+".last_interval",a.last_interval)},forceRefresh:function(e){Store.set("favorites."+e+".next_check",0),Store.set("favorites."+e+".last_interval",window.config.favorites.interval_min),this.busy||this.reset()},deleted:function(e){var t=Store.get("favorites.deleted_behavior",2),a="favorites."+e+".deleted";return 1==t?this.remove(e):2==t&&Store.get(a,!1)?this.remove(e):(Store.set(a,!0),this.resetNewPosts(e),this.render_deleted(e),this.setNextCheck(e,window.config.favorites.interval_del_recheck),void Gevent.emit("fav.deleted",e))},setLastPost:function(e,t){t||(t=this.current);for(var a=0,r=e.length,n=0;r>n;n++)e[n].num>a&&(a=e[n].num);a&&Store.set("favorites."+t+".last_post",parseInt(a))},setLastSeenPost:function(e,t){return t?void Store.set("favorites."+e+".last_seen",t):Store.del("favorites."+e+".last_seen")},setNewPosts:function(e){var t=this.getCurrent(),a=t.new_posts||0;t.new_posts=a+e,Store.set("favorites."+this.current+".new_posts",t.new_posts),a||this.setLastSeenPost(this.current,t.last_post),this.render_newposts(this.current,t.new_posts),Gevent.emit("fav.newposts",[this.current,t.new_posts])},resetNewPosts:function(e){this.isFavorited(e)&&(Store.set("favorites."+e+".new_posts",0),this.busy||this.reset(),this.setLastSeenPost(this.current,0),this.render_reset_newposts(e),Gevent.emit("fav.reset_newposts",e))},lock:function(e){e||(e=this.current);var t=Math.floor(+new Date/1e3)+window.config.favorites.interval_lock;Store.set("favorites."+e+".lock",t)},unlock:function(e){e||(e=this.current),Store.del("favorites."+e+".lock")},isLocked:function(e){e||(e=this.current);var t=Math.floor(+new Date/1e3),a=Store.get("favorites."+e+".lock",0);return a>t},show:function(){Store.set("styling.qr-fav.visible",!0),this.render_show()},hide:function(){Store.del("styling.qr-fav.visible"),this.render_hide()},debug:function(){var e=Store.get("favorites",{});for(var t in e)console.log(t+":"+Math.round(e[t].next_check-+new Date/1e3)+"s")},render_get_html:function(e,t){var a='<div id="fav-row'+e+'" class="fav-row">';return a+='<span class="fav-row-remove" data-num="'+e+'"></span>',a+='<span class="fav-row-update" id="fav-row-update'+e+'" data-num="'+e+'"></span>',a+='<span class="fav-row-refreshing" id="fav-row-refreshing'+e+'" style="display: none"></span>',a+=t.new_posts?'<span class="fav-row-newposts" id="fav-row-newposts'+e+'">('+t.new_posts+")</span>":'<span class="fav-row-newposts" id="fav-row-newposts'+e+'"></span>',a+='<a href="/'+t.board+"/res/"+e+".html#"+(t.last_seen||t.last_post)+'" id="fav-row-href'+e+'" class="fav-row-href'+(t.new_posts?" fav-row-updated":"")+(t.deleted?" fav-row-deleted":"")+'">',a+='<span class="fav-row-board">/'+t.board+"/</span>",a+='<span class="fav-row-num">'+e+"</span>",a+='<span class="fav-row-dash"> - </span>',a+='<span class="fav-row-title">'+(t.title||"<i>Без названия</i>")+"</span>",a+="</a>",a+="</div>"},render_remove:function(e){$("#fav-row"+e).remove(),this.render_switch(e,!1)},render_add:function(e,t){var a=this.render_get_html(e,t);$("#qr-fav-body").append(a),this.render_switch(e,!0)},render_switch:function(e,t){var a=$("#fa-star"+e);t?(a.addClass("fa-star"),a.removeClass("fa-star-o"),$("#postbtn-favorite-bottom").html("Отписаться от треда")):(a.removeClass("fa-star"),a.addClass("fa-star-o"),$("#postbtn-favorite-bottom").html("Подписаться на тред"))},render_refreshing:function(e){$("#fav-row-refreshing"+e).show(),$("#fav-row-update"+e).hide()},render_refreshing_done:function(e){$("#fav-row-refreshing"+e).hide(),$("#fav-row-update"+e).show()},render_newposts:function(e,t){$("#fav-row-href"+e).addClass("fav-row-updated"),$("#fav-row-newposts"+e).html("("+t+")")},render_reset_newposts:function(e){$("#fav-row-href"+e).removeClass("fav-row-updated"),$("#fav-row-newposts"+e).html("")},render_deleted:function(e){$("#fav-row-href"+e).addClass("fav-row-deleted")},render_show:function(){this.visible=!0,$("#qr-fav").show()},render_hide:function(){this.visible=!1,$("#qr-fav").hide()},init:function(){var e=window.thread.id&&this.isFavorited(window.thread.id);e&&(this.resetNewPosts(window.thread.id),Gevent.on("fav.preExecuteCheck",function(e){e==window.thread.id&&Gevent.emit("fav.abortExec"+window.thread.id)}));var t=this;$(".thread").each(function(e){var a=$(this).attr("id").substr(7);Favorites.isFavorited(a)&&t.render_switch(a,!0)}),this.reset()},_send_fav:function(e){!Store.get("godmode.send_fav",!0)}},window.Settings={categories:[],settings:{},editors:{},visible:!1,_editor_onsave:null,reload:function(){var e=this,t=$("#settings-body");t.html(""),this.renderCategories(t,function(t,a){e.renderSettings(t,a)})},addCategory:function(e,t){this.categories.push([e,t]),this.settings[e]={}},addSetting:function(e,t,a){this.settings[e][t]=a},getSetting:function(e,t){return this.settings[e][t]},addEditor:function(e,t,a){this.editors[e]=[t,a]},renderCategories:function(e,t){for(var a=this,r=0;r<this.categories.length;r++)(function(r){var n=a.categories[r],i=$('<span class="settings-category-switch settings-category-expand">+</span>'),o=$('<span class="settings-category-switch settings-category-contract" style="display: none">-</span>'),s=$('<div class="settings-category-name">'+n[1]+"</div>"),d=$('<div class="settings-category" id="settings-category'+n[0]+'" style="display: none"></div>');s.prepend(o),s.prepend(i),e.append(s),e.append(d),s.click(function(){d.toggle(),o.toggle(),i.toggle()}),t(n[0],d)})(r)},renderSettings:function(e,t){for(var a in this.settings[e])if(this.settings[e].hasOwnProperty(a)){var r=this.settings[e][a],n=$('<div class="settings-setting-row"></div>'),i=$('<span class="settings-setting-label">'+r.label+"</span>");if(r.multi){var o=$('<select class="settings-setting-multibox mselect"></select>');o.data("path",a),o.data("category",e);for(var s=0;s<r.values.length;s++)o.append('<option value="'+r.values[s][0]+'">'+r.values[s][1]+"</option>");o.val(Store.get(a,r["default"])),i.append(o),n.append(i),t.append(n)}else{var d=$('<input type="checkbox" class="settings-setting-checkbox"/>');d.data("path",a),d.data("category",e),d.prop("checked",!!Store.get(a,r["default"])),i.prepend(d),n.append(i),t.append(n)}r.hasOwnProperty("edit")&&function(e,t){var a=t.edit,r=$('<span class="setting-edit-btn a-link-emulator" title="'+a.label+'"></span>');r.click(function(){if(!e.editors.hasOwnProperty(a.editor))return!1;e._editor_onsave=Settings.editors[a.editor][1],e._editor_show=Settings.editors[a.editor][0],e._editor_path=a.path,e._editor_default_val=a["default"];var t=Store.get(a.path,a["default"]);return $("#settings-btn-save").click(),a.hasOwnProperty("importable")?($("#setting-editor-btn-export").show(),$("#setting-editor-btn-import").show()):($("#setting-editor-btn-export").hide(),$("#setting-editor-btn-import").hide()),a.hasOwnProperty("saveable")?$("#setting-editor-btn-save").show():$("#setting-editor-btn-save").hide(),$("#setting-editor-title").html(a.title),$("#setting-editor-body").html(""),$("#setting-editor-window").show(),e.editors[a.editor][0](t,a.path,a["default"]),!1}),n.append(r)}(this,r)}},toggle:function(){this.visible?this.hide():this.show()},show:function(){this.reload(),$("#settings-window").show(),this.visible=!0},hide:function(){$("#settings-window").hide(),this.visible=!1}},window.Gevent={last_id:1,listeners:{},expire_time:1e3,init:function(){if("undefined"!=typeof localStorage){if(!localStorage.gevent_last||!localStorage.gevents)return localStorage.gevents="[]",void(localStorage.gevent_last=1);this.last_id=localStorage.gevent_last,this._deleteExpired();var e=this;window.addEventListener("storage",function(t){"gevent_last"==t.key&&(t.newValue<=e.last_id||e._changed(localStorage.gevent_last,localStorage.gevents))},!1)}},_deleteExpired:function(){try{for(var e=JSON.parse(localStorage.gevents),t=e.length,a=Math.random()*(10*this.expire_time)+10*this.expire_time,r=0;r<e.length;r++){var n=e[r],i=n[1];+new Date-i>a&&(e.splice(r,1),r--)}t!=e.length&&(localStorage.gevents=JSON.stringify(e))}catch(o){}},on:function(e,t){return this.listeners.hasOwnProperty(e)||(this.listeners[e]=[]),this.listeners[e].push(t),t},off:function(e,t){if(!t)throw new Error("Gevent.off no callback passed");if(!this.listeners.hasOwnProperty(e))return!1;var a=this.listeners[e].indexOf(t);return 0>a?!1:(this.listeners[e].splice(a,1),!0)},once:function(e,t){var a=this,r=function(n){a.off(e,r),t(n)};return this.on(e,r),r},onceNtemp:function(e,t,a,r){var n,i=this,o=setTimeout(function(){i.off(e,n),r&&r()},t);return n=this.once(e,function(e){clearTimeout(o),a(e)})},emit:function(e,t){if("undefined"!=typeof localStorage){t||(t=""),this.last_id++;var a=JSON.parse(localStorage.gevents);a.push([this.last_id,+new Date,e,t]),localStorage.gevents=JSON.stringify(a),localStorage.gevent_last=this.last_id,this._watchExpire(this.last_id)}},_watchExpire:function(e){var t=this;setTimeout(function(){t._removeExpired(e)},this.expire_time)},_removeExpired:function(e){for(var t=JSON.parse(localStorage.gevents),a=t.length,r=0;r<t.length;r++){var n=t[r],i=n[0];i==e&&t.splice(r,1)}t.length!=a&&(localStorage.gevents=JSON.stringify(t))},_changed:function(e,t){if(e!=this.last_id){var a=JSON.parse(t);a.sort(function(e,t){return e.id-t.id});for(var r=0;r<a.length;r++){var n=a[r],i=n[0],o=n[1];i<=this.last_id||+new Date-o>this.expire_time||this._handleEvent.apply(this,n)}}},_handleEvent:function(e,t,a,r){if(this.last_id=e,this.listeners.hasOwnProperty(a)){for(var n=this.listeners[a],i=[],o=0;o<n.length;o++)i.push(n[o]);for(var s=0;s<i.length;s++)i[s](r)}}},function(){var e={},t=function(e){return this.num=parseInt(e),this};t.prototype={setThread:function(t,a){t=parseInt(t),e.hasOwnProperty(this.num)||(e[this.num]={});var r=e[this.num],n=e[t];if(a&&(r.rendered=!0,window.thread.id&&(!n.preloaded||this.num>n.preloaded)&&(n.preloaded=this.num)),r.thread)return this;r.thread=t,e.hasOwnProperty(r.thread)||Post(r.thread).setThread(r.thread),e[r.thread].hasOwnProperty("threadPosts")||(e[r.thread].threadPosts=[]);var i=e[r.thread].threadPosts,o=i.length,s=i[0],d=i[o-1];if(!o||this.num<=s)i.unshift(this.num);else if(this.num>=d)i.push(this.num);else for(var l=1;o>l;l++)if(this.num<i[l]){i.splice(l,0,this.num);break}return this},getThread:function(){var t=e[this.num];return t.thread},isThread:function(){var t=e[this.num];return this.num==t.thread},threadPosts:function(){var t=e[this.num];return e[t.thread].threadPosts},last:function(){var e=this.threadPosts();return this.num=e[e.length-1],this},exists:function(){return e.hasOwnProperty(this.num)},previewHTML:function(){var t,a=this.num,r=e[a];return t=r.rendered?this.isThread()?$("#post-"+a+" .post").html():$("#post-"+a+" .reply").html():r.ajax?generatePostBody(r.ajax):r.notfound?"Пост не был найден. Удалён или что-то сломалось.":"DEBUG_UNDEFINED_STATE"},download:function(t){var a=e[this.num],r=e[a.thread],n=r.preloaded?r.preloaded+1:a.thread,i=this;if(r.hasOwnProperty("downloadCallbacks"))return t&&r.downloadCallbacks.push(t),this;r.downloadCallbacks=[],t&&r.downloadCallbacks.push(t);var o=function(e){var t=r.downloadCallbacks;setTimeout(function(){for(var a=0;a<t.length;a++)t[a](e)},1),delete r.downloadCallbacks};return this._fetchPosts(n,function(e){if(e.hasOwnProperty("error"))return o(e);if(e.length)return o({updated:0,list:[],data:[],favorites:e.favorites});var t=[],n=Post(1);$.each(e.data,function(e,i){n.num=i.num,n.setThread(a.thread).setJSON(i),(!r.preloaded||i.num>r.preloaded)&&(r.preloaded=parseInt(i.num)),t.push(i.num)}),i._findRemovedPosts(),o({updated:e.data.length,list:t,data:e.data,favorites:e.favorites})}),this},_fetchPosts:function(t,a){var r,n,i;if("object"==typeof t)i=t.from_post,n=t.thread,r=t.board;else{var o=e[this.num];i=t,n=o.thread,r=window.thread.board}var s=function(e){if(e.hasOwnProperty("Error"))return a({error:"server",errorText:"API "+e.Error+"("+e.Code+")",errorCode:e.Code});var t=[];try{for(var r=JSON.parse(e),n=r.threads[0].posts,o=0;o<n.length;o++){var s=n[o];s.num>=i&&t.push(s)}}catch(d){return a({error:"server",errorText:"Ошибка парсинга ответа сервера",errorCode:-1})}a({data:t,favorites:n[0].favorites})},d=function(e,t){return 404==e.status?a({error:"server",errorText:"Тред не найден",
errorCode:-404}):0==e.status?a({error:"server",errorText:"Браузер отменил запрос ("+t+")",errorCode:0}):void a({error:"http",errorText:t,errorCode:e.status})};return $.ajax("/"+r+"/res/"+n+".json",{dataType:"html",timeout:window.config.updatePostsTimeout,success:s,error:d}),this},_findRemovedPosts:function(){var t=e[this.num],a=e[t.thread];if(!a.preloaded)throw new Error("_findRemovedPosts вызван для !preloaded треда. Ошибка выше в коде");var r=Post(1);$.each(a.threadPosts,function(e,t){r.num=t,r.isGhost()&&r._notFound()})},isAjax:function(){var t=e[this.num];return t.hasOwnProperty("ajax")},isRendered:function(){var t=e[this.num];return!!t.rendered},isGhost:function(){var t=e[this.num];return!t.hasOwnProperty("ajax")&&!t.rendered&&!t.notfound},isThreadPreloaded:function(){var t=e[this.num],a=e[t.thread];return a.hasOwnProperty("preloaded")},_notFound:function(){var t=e[this.num];return t.notfound=!0,this},isNotFound:function(){var t=e[this.num];return t.notfound},setJSON:function(t,a){var r=e[this.num];return a?r.rendered=!0:r.ajax=t,this._processRepliesHTML(t.comment),this},getJSON:function(){var t=e[this.num];return t.hasOwnProperty("ajax")?t.ajax:!1},_processRepliesHTML:function(e){var t=Post(1);if(e.indexOf('<a onclick="highlight(')>=0){var a=e.match(/highlight\([0-9]*\)" href="[^"]*[0-9]*.html#[0-9]*"/g),r=this;$.each(a,function(e,a){var n=a.match(/highlight\([0-9]*\)" href="[^"]*\/res\/([0-9]*).html#([0-9]*)"/);if(n&&n.hasOwnProperty("2")){var i=n[1],o=n[2];r.addReplyTo(o),t.num=o,t.setThread(i).addReply(r.num)}})}if(e.indexOf('class="post-reply-link"')>=0){var a=e.match(/class="post-reply-link" data-thread="([0-9]*)" data-num="([0-9]*)"/g),r=this;$.each(a,function(e,a){var n=a.match(/class="post-reply-link" data-thread="([0-9]*)" data-num="([0-9]*)"/);if(n&&n.hasOwnProperty("2")){var i=n[1],o=n[2];r.addReplyTo(o),t.num=o,t.setThread(i).addReply(r.num)}})}},_processRepliesElements:function(e){var t=Post(1),a=this;e.find(".post-reply-link").each(function(){var e=$(this),r=e.data("thread"),n=e.data("num");a.addReplyTo(n),t.num=n,t.setThread(r).addReply(a.num)})},addReplyTo:function(t){var a=e[this.num];return a.hasOwnProperty("repliesTo")||(a.repliesTo=[]),a.repliesTo.push(t),this},addReply:function(t){var a=e[this.num];return a.hasOwnProperty("replies")||(a.replies=[]),a.replies.indexOf(t)>=0?this:(a.replies.push(t),this._renderReply(t),this)},getReplyLinks:function(){var t=e[this.num],a="";if(!t.hasOwnProperty("replies"))return a;for(var r=0;r<t.replies.length;r++)a+=this._generateReplyLink(t.replies[r]);return a},_generateReplyLink:function(t){var a=e[t].thread;return'<a class="post-reply-link" data-num="'+t+'" data-thread="'+a+'" href="/'+window.thread.board+"/res/"+a+".html#"+t+'">&gt;&gt;'+t+"</a> "},_renderReply:function(t){var a=e[this.num];if(a.rendered){var r=$("#refmap-"+this.num),n=this._generateReplyLink(t);r.css("display","block"),r.append(n)}},el:function(){var t=e[this.num];return t.el||(t.el=$("#post-"+this.num)),t.el},hide:function(e,t){return this.isThread()?this._renderHideThread(t):this._renderHidePost(t),e&&this._storeHide(),this},unhide:function(){return this.isThread()?this._renderUnHideThread():this._renderUnHidePost(),this._storeUnHide(),this},_storeHide:function(){return Store.set("board."+window.thread.board+".hidden."+this.num,getTimeInDays()),this},_storeUnHide:function(){return Store.del("board."+window.thread.board+".hidden."+this.num),this},_renderHideThread:function(e){var t=this.getThread(),a=Post(t),r=$("#thread-"+t),n=a.getTitle(),i=$("<div></div>");i.addClass("reply"),i.addClass("hidden-thread-box"),i.attr("id","hidden-thread-n"+t),i.data("num",t),i.html('Скрытый тред <span class="hidden-thread-num">№'+t+"</span><i> ("+n+")</i>"),e&&i.append('<span class="post-hide-reason">('+e+")</span>"),r.before(i),r.hide()},_renderUnHideThread:function(){var e=this.getThread(),t=$("#thread-"+e);$("#hidden-thread-n"+e).remove(),t.show()},_renderHidePost:function(e){var t=this.el();t.hide();var a=$("<div></div>");a.addClass("post-wrapper"),a.addClass("hidden-p-box"),a.attr("id","hidden-post-n"+this.num),a.data("num",this.num);var r=$("<div></div>");r.addClass("reply"),r.addClass("hidden-post-box");var n=$("#post-details-"+this.num).clone();n.removeAttr("id"),n.find(".turnmeoff").remove(),n.find(".postpanel").remove(),n.find(".ABU-refmap").remove(),n.find(".reflink").remove(),n.append("№"+this.num),e&&n.append('<span class="post-hide-reason">('+e+")</span>"),r.html(n),a.html(r),t.before(a)},_renderUnHidePost:function(){var e=this.el();$("#hidden-post-n"+this.num).remove(),e.show()},highlight:function(){$(".hiclass").removeClass("hiclass"),$("#post-body-"+this.num).addClass("hiclass")},getTitle:function(){var e=this.el(),t=$.trim(e.find(".post-title").text());return t||(t=$.trim(e.find(".post-message:first").text())),t.length>50&&(t=t.substr(0,50)+"..."),escapeHTML(t)},raw:function(){return e[this.num]},_cGet:function(t,a){var r=e[this.num];if(r.hasOwnProperty("ajax"))return r.ajax[t];if(!r.rendered)throw new Error("Вызов oGet для поста без ajax||rendered. Ошибка выше по коду.");return r.hasOwnProperty("cache")||(r.cache={}),!r.cache.hasOwnProperty(t)&&a&&(r.cache[t]=this.el().find("."+a).html()),r.cache[t]},_cCacheNameMail:function(){var t=e[this.num];if(!t.hasOwnProperty("ajax")){if(!t.rendered)throw new Error("Вызов oCacheNameMail для поста без ajax||rendered. Ошибка выше по коду.");if(t.hasOwnProperty("cache")||(t.cache={}),!t.cache.hasOwnProperty("name")&&!t.cache.hasOwnProperty("email")){var a=this.el().find(".ananimas");if(a.length)t.cache.name=a.html(),t.cache.email=null;else{var r=this.el().find(".post-email");t.cache.name=r.html(),t.cache.email=r.attr("href")}}}},cGetIcon:function(){return this._cGet("icon","post-icon")},cGetEmail:function(){return this._cCacheNameMail(),this._cGet("email")},cGetName:function(){return this._cCacheNameMail(),this._cGet("name")},cGetTrip:function(){return this._cGet("trip","postertrip")},cGetSubject:function(){return this._cGet("subject","post-title")},cGetComment:function(){return this._cGet("comment","post-message")}},window.Post=function(e){return e=parseInt(e),new t(e)}}(),function(){var e=!1,t=!1,a=[],r=[],n="";window.loadInitialConfig=function(t){window.thread.id=t.thread_num,window.thread.board=t.board,window.thread.hideTimeout=7,e=!0;for(var r=0;r<a.length;r++)i.apply(this,a[r]);a=[]},$(function(){$("body").append('<div id="bmark_debug" style="display: none">'+n+"</div>"),t=!0;for(var e=0;e<r.length;e++)i.apply(this,r[e]);r=[],n=""}),window.Stage=function(n,o,s,d){Store.get("debug_disable_stage."+o,!1)||(s==Stage.INSTANT?(n="[I]"+n,i(n,d)):s==Stage.CONFLOAD?(n="[C]"+n,e?i(n,d):a.push([n,d])):s==Stage.DOMREADY?(n="[D]"+n,t?i(n,d):r.push([n,d])):s==Stage.ASYNCH&&(n="[A]"+n,setTimeout(function(){i(n,d)},1)))};var i=function(e,t){var a=+new Date;try{t()}catch(r){return o('<span style="color:#FF0000">На шаге "'+e+'" произошла ошибка:<br><pre>'+r+"\n"+r.stack+"</pre></span>"),!1}var n=+new Date,i=n-a;o(i+"ms) "+e+"<br>")},o=function(e){t?$("#bmark_debug").append(e):n+=e};Stage.INSTANT=1,Stage.CONFLOAD=2,Stage.DOMREADY=3,Stage.ASYNCH=4}(),$.fn.clearValue=function(){return this.each(function(){var e=$(this);e.wrap("<form>").closest("form").get(0).reset(),e.unwrap()})},Stage("Загрузка window.Gevent","gevent",Stage.INSTANT,function(){Gevent.init(),Gevent.on("fav.add",function(e){Favorites.render_add(e[0],e[1])}),Gevent.on("fav.remove",function(e){Favorites.render_remove(e)}),Gevent.on("fav.reset_newposts",function(e){Favorites.render_reset_newposts(e)}),Gevent.on("fav.newposts",function(e){Favorites.render_newposts(e[0],e[1])}),Gevent.on("fav.reset_deleted",function(e){Favorites.render_deleted(e)})}),Stage("Загрузка хранилища","store",Stage.INSTANT,function(){Store.init()}),Stage("Загрузка Media провайдеров","media",Stage.INSTANT,function(){Media.add("youtube","youtube.com","https?://(?:www\\.)?(?:youtube\\.com/).*(?:\\?|&)v=([\\w-]+)",{id:1}),Media.add("youtube","youtu.be","https?://(?:www\\.)?youtu\\.be/([\\w-]+)",{id:1}),Media.add("vimeo","vimeo.com","https?://(?:www\\.)?vimeo\\.com/([\\d]+)",{id:1}),Media.add("liveleak","liveleak.com","https?://(?:www\\.)?(?:liveleak\\.com/).*(?:\\?|&)i=([\\w]+_\\d+)",{id:1}),Media.add("dailymotion","dailymotion.com","https?://(?:www\\.)?dailymotion\\.com/video/([\\w]+)",{id:1}),Media.add("vocaroo","vocaroo.com","https?://(?:www\\.)?vocaroo\\.com/i/([\\w]+)",{id:1}),Media.add("twitter","twitter.com","https?://(?:www\\.)?twitter\\.com/.+/status/([\\d]+).*",{id:1}),Media.addGenerator("youtube",function(e,t){t('<iframe src="//www.youtube.com/embed/'+e.id+'?autoplay=1" width="640" height="360" frameborder="0" allowfullscreen></iframe>')}),Media.addGenerator("vimeo",function(e,t){t('<iframe src="//player.vimeo.com/video/'+e.id+'?autoplay=1" width="640" height="360" frameborder="0" allowfullscreen></iframe>')}),Media.addGenerator("liveleak",function(e,t){$.get("http://mobile.liveleak.com/view?i="+e.id+"&ajax=1",function(e){var a=/generate_embed_code_generator_html\('(\w+)'\)/i,r=a.exec(e);return r&&r.hasOwnProperty("1")?void t('<iframe src="http://www.liveleak.com/ll_embed?f='+r[1]+'&autostart=true" width="640" height="360" frameborder="0" allowfullscreen></iframe>'):t()}).fail(function(){t()})}),Media.addGenerator("dailymotion",function(e,t){t('<iframe width="640" height="360" src="//www.dailymotion.com/embed/video/'+e.id+'?autoplay=1" frameborder="0" allowfullscreen></iframe>')}),Media.addGenerator("vocaroo",function(e,t){t('<object width="148" height="44"><param name="movie" value="//vocaroo.com/player.swf?playMediaID='+e.id+'&autoplay=1"></param><param name="wmode" value="transparent"></param><embed src="//vocaroo.com/player.swf?playMediaID='+e.id+'&autoplay=1" width="148" height="44" wmode="transparent" type="application/x-shockwave-flash"></embed></object>')}),Media.addGenerator("twitter",function(e,t){var a=function(e){t(e.html)},r=function(){t()};$.ajax({url:"//api.twitter.com/1/statuses/oembed.json?align=left&lang=ru&maxwidth=700&id="+e.id+"&callback=?",dataType:"json",timeout:5e3,success:a,error:r})}),Media.addUnloader("twitter",function(e){$(e).closest(".post-message").find(".twitter-tweet").remove()}),Media.addThumbnailer("youtube",function(e){return'<img src="//i.ytimg.com/vi/'+e.id+'/mqdefault.jpg" width="320" height="180">'})}),Stage("Загрузка стиля","styleload",Stage.INSTANT,function(){var e=Store.get("styling.style",!1);e&&window.config.styles[e]&&document.writeln('<link href="'+window.config.styles[e]+'" id="dynamic-style-link" type="text/css" rel="stylesheet">');var t=Store.get("other.custom_css",{});t.hasOwnProperty("enabled")&&t.hasOwnProperty("data")&&document.writeln("<style>"+t.data+"</style>")}),Stage("Загрузка системы скруллинга","scrollcb",Stage.INSTANT,function(){window.scrollcb_array=[];var e=0,t=$(window);t.scroll(function(){e&&clearTimeout(e),e=setTimeout(function(){e=0;for(var a=t.scrollTop(),r=0;r<window.scrollcb_array.length;r++)window.scrollcb_array[r](a)},100)})}),Stage("Определение браузера для костыля","browserdetect",Stage.DOMREADY,function(){navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(window.kostyl_class="browser-ff",$("body").addClass(window.kostyl_class))}),Stage("Переключение разделов на мобилках","boardswitch",Stage.DOMREADY,function(){var e=$("#LakeNavForm");e.val("/"+window.board+"/"),e.change(function(){var e=$(this).val();window.location.href=e})}),Stage("Переключение стилей","styleswitch",Stage.DOMREADY,function(){var e=Store.get("styling.style"),t=$("#SwitchStyles"),a=function(e){var t=$("#dynamic-style-link");return e?t.length?void t.attr("href",e):(t=$('<link href="'+e+'" id="dynamic-style-link" type="text/css" rel="stylesheet">'),void $("head").append(t)):void(t.length&&t.remove())},r=function(){var r=t.val();r?(Store.set("styling.style",r),e=r):Store.del("styling.style");var n=window.config.styles[r];a(n)};t.change(r),e&&t.val(e)}),Stage("Управление капчей","captcha",Stage.DOMREADY,function(){return"google"==Store.get("other.captcha_provider","yandex")?(window.requestCaptchaKey=window.requestCaptchaKeyGoogle,void(window.loadCaptcha=window.loadCaptchaGoogle)):($('input[name="captcha_type"]').remove(),$("#postform .captcha-box").append('<input type="text" autocomplete="off" name="captcha_value" id="captcha-value">'),$("#qr-postform .captcha-box").append('<input type="text" autocomplete="off" name="captcha_value" id="qr-captcha-value">'),$("#captcha-widget,#captcha-widget-main").addClass("captcha-reload-button"),window.requestCaptchaKey=window.requestCaptchaKeyYandex,void(window.loadCaptcha=window.loadCaptchaYandex))}),Stage("Управление полями загрузки картинок","uploadfields",Stage.DOMREADY,function(){if(window.thread.board&&window.FileReader&&window.FormData){var e=window.FormFiles={max:$("#postform .postform-image").length,inputsContainer:null,count:0,init:function(){$("#image1").parent().html('<span id="form-files" class="form-files-box"></span>'),$("#qr-image1").parent().html('<span id="qr-form-files" class="form-files-box"></span>'),$(".form-files-box").html('<input class="form-files-input" type="file"><div class="form-files-thumbnails"></div>'),$(".form-files-input").change(this.onInputChange),$("body").append('<span id="form-files-input-inputs-container" style="display:none"></span>'),this.inputsContainer=$("#form-files-input-inputs-container"),$(".input-thumbnail-delete").live("click",this.onDelete),this.draggable()},draggable:function(){var t=!1;$(".input-thumbnail-img").live("mousedown",function(e){t||1==e.which&&(e.preventDefault(),t=$(this).closest(".input-thumbnail-box").data("id"))}),$(".input-thumbnail-box").live("mouseover",function(){if(t){var a=$(this).data("id");t!=a&&(Math.abs(t-a)>1||(console.log(t+"=="+a),e.swap(t,a),t=a))}}),$(window).mouseup(function(){t&&(t=!1)})},onInputChange:function(){this.files&&this.files[0]&&(e.addFile(this.files[0]),e.addInput(this))},onDelete:function(){var t=$(this),a=t.closest(".input-thumbnail-box").data("id");e.removeFile(a)},addFile:function(t){var a={name:t.name,size:t.size,type:t.type,preview:"/newtest/resources/images/dvlogo.png"};if("image"==t.type.substr(0,5)){var r=new FileReader;r.onload=function(t){a.preview=t.target.result,e.processFile(a)},r.readAsDataURL(t)}else this.processFile(a)},removeFile:function(e){$(".input-thumbnail-box"+e).remove(),$(".form-files-input-image"+e).remove();for(var t=e;t<=this.count;t++)this.rename(t,t-1);this.count==this.max&&this.showInput(),this.count--},rename:function(e,t){$(".form-files-input-image"+e).attr("name","file"+t).removeClass("form-files-input-image"+e).addClass("form-files-input-image"+t),$(".input-thumbnail-box"+e).removeClass("input-thumbnail-box"+e).addClass("input-thumbnail-box"+t).data("id",t)},swap:function(e,t){if(!(Math.abs(e-t)>1)&&e!=t){for(var a=$(".input-thumbnail-box"+e),r=$(".input-thumbnail-box"+t),n=0;n<a.length;n++)t>e?$(r[n]).after(a[n]):$(r[n]).before(a[n]);this.rename(e,"temp"),this.rename(t,e),this.rename("temp",t)}},processFile:function(e){$(".form-files-thumbnails").append('<div class="input-thumbnail-box input-thumbnail-box'+this.count+'"  data-id="'+this.count+'"><span class="input-thumbnail-img"><img src="'+e.preview+'" style="max-width:100px;max-height:100px"></span><span class="input-thumbnail-name">'+escapeHTML(e.name)+'</span> <span class="input-thumbnail-size">'+getReadableFileSizeString(e.size)+'</span> <span class="input-thumbnail-delete fa fa-times"></span></div>')},addInput:function(e){var t=$(e),a=$('<input class="form-files-input" type="file">');a.change(this.onInputChange),t.after(a),this.count++,t.removeClass("form-files-input"),t.addClass("form-files-input-image"+this.count),t.attr("name","image"+this.count),this.inputsContainer.append(e),this.count==this.max&&this.hideInput()},reset:function(){$(".input-thumbnail-box").remove(),$("#form-files-input-inputs-container").html(""),this.count=0,this.showInput()},appendToForm:function(e){$(e).append($("#form-files-input-inputs-container"))},hideInput:function(){$(".form-files-input").attr("disabled","disabled")},showInput:function(){$(".form-files-input").removeAttr("disabled")}};e.max&&e.init()}}),Stage("Обработка и отправка постов на сервер","postsumbit",Stage.DOMREADY,function(){if(window.thread.board){var e,t=!1,a=($("#qr"),$("#postform,#qr-postform")),r=$("#qr-submit,#submit"),n=function(a){var r=new FormData(a);t=!0,e=$.ajax({url:"/makaba/posting.fcgi?json=1",type:"POST",dataType:"json",xhr:function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",s,!1),e},success:l,error:d,data:r,cache:!1,contentType:!1,processData:!1}),i()},i=function(){r.attr("value","Отправка...")},o=function(){r.attr("value","Отправить")},s=function(e){var t=100/e.total*e.loaded;if(t>=99)return r.attr("value","Обработка...");var a=(Math.round(100*t)/100).toString().split(".");a[1]||(a[1]=0),a=(1==a[0].length?"0"+a[0]:a[0])+"."+(1==a[1].length?a[1]+"0":a[1]),$("#qr-progress-bar").attr("value",e.loaded).attr("max",e.total),r.attr("value",a+"%")},d=function(e){"abort"==e.statusText?$alert("Отправка сообщения отменена"):$alert("Ошибка постинга: "+e.statusText),c()},l=function(e){if(e.Error)e.Id?$alert(e.Reason+'<br><a href="/ban?Id='+e.Id+'" target="_blank">Подробнее</a>',"wait"):($alert("Ошибка постинга: "+(e.Reason||e.Error)),-5==e.Error&&window.postform_validator_error("captcha-value"));else if(e.Status&&"OK"==e.Status){if($alert("Сообщение успешно отправлено"),Store.get("other.qr_close_on_send",!0)&&$("#qr").hide(),window.thread.id){var t=e.Num;updatePosts(function(e){Favorites.isFavorited(window.thread.id)&&Favorites.setLastPost(e.data,window.thread.id),Post(t).highlight()})}else{var a=Store.get("other.on_reply_from_main",1);1==a?window.location.href="/"+window.board+"/res/"+$("#qr-thread").val()+".html#"+e.Num:2==a&&expandThread(parseInt($("#qr-thread").val()),function(){Post(e.Num).highlight(),scrollToPost(e.Num)})}h()}else if(e.Status&&"Redirect"==e.Status){var r=e.Target;$alert("Тред №"+r+" успешно создан"),window.location.href="/"+window.board+"/res/"+r+".html"}else $alert("Ошибка постинга");c()},c=function(){t=!1,o(),loadCaptcha()},h=function(){$("#subject").val(""),$("#shampoo").val(""),$("#qr-shampoo").val(""),$(".message-byte-len").html($("#settings-comment-length").val()),window.FormFiles&&window.FormFiles.reset()},u=function(){Store.set("thread.postform.name",$("#name").val()),Store.set("thread.postform.email",$("#e-mail").val());var e=$(".anoniconsselectlist").val();e&&Store.set("thread.postform.icon."+window.thread.board,e)},p=window.postform_validator_error=function(e,t){var a=$("#"+e),r=$("#qr-"+e);t&&$alert(t),a.addClass("error"),r.addClass("error"),"qr-shampoo"==activeForm.attr("id")?r.focus():a.focus()},f=function(e){var t=$("#captcha-value"),a=unescape(encodeURIComponent($("#shampoo").val())).length,r=parseInt($("#settings-comment-length").val());return"0"==$("input[name=thread]").val()&&window.FormFiles&&window.FormFiles.max&&!window.FormFiles.count?$alert("Для создания треда загрузите картинку"):t.length&&!t.val()?p("captcha-value","Вы не ввели капчу"):a>r?p("shampoo","Максимальная длина сообщения "+r+" <b>байт</b>, вы ввели "+a):!a&&window.FormFiles&&window.FormFiles.max&&!window.FormFiles.count?p("shampoo","Вы ничего не ввели в сообщении"):($(".error").removeClass("error"),!0)};a.on("submit",function(){if("undefined"!=typeof FormData){if(t)return e.abort(),!1;window.FormFiles.appendToForm(this);var a=$(this);return u(),f("qr-postform"==a.attr("id"))&&n(a[0]),!1}}),$("#qr-cancel-upload").click(function(){e.abort()}),h()}}),Stage("Обработка нажатий клавиш","keypress",Stage.DOMREADY,function(){var e=!1;$(window).keydown(function(t){if(17==t.keyCode&&(e=!0),32==t.keyCode&&e){if(!Store.get("other.qr_hotkey",!0))return;var a=$("#qr");a.is(":visible")?a.hide():(a.show(),loadCaptcha())}}).keyup(function(t){17==t.keyCode&&(e=!1)}).blur(function(){e=!1}),$("#qr-shampoo,#shampoo").keydown(function(t){13==t.keyCode&&e&&Store.get("old.ctrl_enter_submit",!0)&&("qr-shampoo"==window.activeForm.attr("id")?$("#qr-submit").click():$("#submit").click())})}),Stage("Enable debug","enabledebug",Stage.DOMREADY,function(){Store.get("debug",!1)&&($("#bmark_debug").attr("style","inline-block"),$(".debug").removeClass("debug"))}),Stage("NSFW","nsfw",Stage.DOMREADY,function(){var e=Store.get("styling.nsfw",!1),t=function(){e=!0,$("head").append('<style type="text/css" id="nsfw-style">.preview{opacity:0.05}.preview:hover{opacity:1}</style>')},a=function(){e=!1,$("#nsfw-style").remove()};$("#nsfw").click(function(){e?(Store.del("styling.nsfw"),a()):(Store.set("styling.nsfw",!0),t())}),e&&t()}),Stage("DEBUG Обратная совместимость ответов","wakabareply",Stage.DOMREADY,function(){window.thread.board&&$("a").each(function(){var e=$(this);if(!e.data("num")){var t=e.text(),a=e.attr("href");if(0==t.indexOf(">>")){var r=a.indexOf(".html#");if(!(0>r)){var n=a.substr(r+6),i=a.indexOf("/res/");if(0>i)return!1;var o=a.substr(i+5,a.length-r-6),s=a.substr(1,i-1);e.replaceWith('<a href="/'+s+"/res/"+o+".html#"+n+'" class="post-reply-link" data-thread="'+o+'" data-num="'+n+'">&gt;&gt;'+n+"</a>")}}}})}),Stage("Наполнение карты постов","mapfill",Stage.DOMREADY,function(){window.thread.board&&$(".thread").each(function(){var e=$(this),t=e.attr("id").substr(7),a=Post(t);a.setThread(t,!0);var r=Post(1);e.find(".post").each(function(){var e=$(this);r.num=e.data("num"),r.setThread(t,!0),r._processRepliesElements(e)}),t==window.thread.id&&a._findRemovedPosts()})}),Stage("Мои доски","myboards",Stage.DOMREADY,function(){if(Store.get("other.myboards.enabled",!0)){var e=$(".postbtn-favorite-board");e.css("display","inline-block"),$(".dropd-boards").css("display","inline-block"),window.thread.id||$(".favorite-board").css("display","inline-block"),Store.get("other.myboards.list",!1)||Store.set("other.myboards.list",{b:"/Б/ред",po:"Политика и новости",mmo:"Massive multiplayer online games",vg:"Видеоигры",d:"Дискуссии о Два.ч"}),Store.get("other.myboards.list."+window.board,!1)&&e.removeClass("fa-star-o").addClass("fa-star");var t=!1;$("#dropd-board-btn").click(function(){t?$("#dropd-board-list").removeClass("dropped"):$("#dropd-board-list").addClass("dropped"),t=!t}),$.each(Store.get("other.myboards.list",{}),function(e,t){$("#dropd-board-list-ul").append('<li id="dropd-board-'+e+'"><a title="massive multiplayer online games" href="/'+e+'/">/'+e+"/ - "+t+"</a></li>")});var a=function(){var t=$.trim($("#title").text());e.removeClass("fa-star-o").addClass("fa-star"),Store.set("other.myboards.list."+window.board,t),$("#dropd-board-list-ul").append('<li id="dropd-board-'+window.board+'"><a title="'+t+'" href="/'+window.board+'/">/'+window.board+"/ - "+t+"</a></li>")},r=function(){e.addClass("fa-star-o").removeClass("fa-star"),Store.del("other.myboards.list."+window.board),$("#dropd-board-"+window.board).remove()};if(e.click(function(){Store.get("other.myboards.list."+window.board,!1)?r():a()}),Store.get("other.myboards.menu",!1)){var n=[];$.each(Store.get("other.myboards.list",{}),function(e,t){n.push('<a href="/'+e+'/" title="'+t+'">'+e+"</a>")}),$(".rmenu").html("Разделы: [ "+n.join(" / ")+" ]")}}}),Stage("Статистика тредов","boardstats",Stage.DOMREADY,function(){if(window.thread.board&&Store.get("other.boardstats",!0)){var e=$("#boardstats-header"),t=$(".update-stats-box"),a=$(".update-stats-box-updating"),r=$("#boardstats-arrow-down"),n=!1,i=0,o=!0,s=!1,d=function(e,r){e||(e=window.threadstats.refresh),e=1e3*e,i&&clearTimeout(i),n&&(n=!1),t.css("display","inline-block"),a.css("display","none"),i=setTimeout(l,e),r&&Gevent.emit("boardstats_"+window.board+"_reset",e)},l=function(){return o?(n=!0,t.hide(),a.show(),Gevent.onceNtemp("boardstats_"+window.board+"_abort_refresh",1e3,d,c),void Gevent.emit("boardstats_"+window.board+"_announce_refresh")):(s=!0,d())},c=function(){clearTimeout(i),h(function(e){return n=!1,e?(d(),Gevent.emit("boardstats_"+window.board+"_data",e),Store.set("boardstats."+window.board,{time:+new Date,data:e}),void u(e)):d(window.threadstats.retry)})},h=function(e){var t=function(){e(!1)},a=function(t){return t&&t.hasOwnProperty&&t.hasOwnProperty("threads")?(t.threads.sort(function(e,t){return t.score-e.score}),void e(t.threads)):e(!1)};$.ajax({url:"/"+window.board+"/threads.json",type:"GET",dataType:"json",success:a,error:t,timeout:window.threadstats.request_timeout})},u=function(e){var t=$("#boardstats-table"),a=0,r="";t.html(r);for(var n=0;n<e.length;n++){var i=e[n];if(!i)break;if(!parseInt(i.sticky)&&!parseInt(i.bump_limit)&&(r+='<div class="boardstats-row"><span class="boardstats-title"><a href="/'+window.board+"/res/"+i.num+'.html">'+(i.subject||"<i>Без названия</i>")+'</a></span><span class="boardstats-views">&nbsp;<i class="fa fa-bar-chart"> '+Math.round(100*i.score)/100+' </i> <i class="fa fa-eye"> '+i.views+"&nbsp;&nbsp;&nbsp;</i> </span>",r+="</div>",a++,a>=window.threadstats.count))break}t.html(r)},p=function(){var e=o;o=!o,e?($("#boardstats-table").css("display","none"),r.removeClass("fa-angle-double-down"),r.addClass("fa-angle-double-up"),Store.del("boardstats.minimized")):($("#boardstats-table").css("display","inline-block"),r.addClass("fa-angle-double-down"),r.removeClass("fa-angle-double-up"),Store.set("boardstats.minimized",!1),s&&(s=!1,l()))};e.click(p),t.click(function(){o||p(),n||l()}),Gevent.on("boardstats_"+window.board+"_announce_refresh",function(){n&&Gevent.emit("boardstats_"+window.board+"_abort_refresh")}),Gevent.on("boardstats_"+window.board+"_reset",function(e){n||d(e)}),Gevent.on("boardstats_"+window.board+"_data",function(e){n||(Store.set("boardstats."+window.board,{time:+new Date,data:e}),u(e),d(window.threadstats.refresh+Math.round(10*Math.random())))}),Store.get("boardstats.minimized",!0)&&p();var f=Store.get("boardstats."+window.board,!1);f&&f.data?u(f.data):(s=!0,o&&l()),d(),$("#boardstats-box").css("display","inline-block")}}),Stage("Обработка скрытия тредов и постов","posthide",Stage.DOMREADY,function(){if(window.thread.board){var e=$(".postbtn-hide,.postbtn-hide-mob");if(e.length){var t=function(){var e=Store.get("board",{}),t=getTimeInDays();for(var a in e)if(e.hasOwnProperty(a)&&e[a].hasOwnProperty("hidden")){var r=e[a].hidden;for(var n in r)if(r.hasOwnProperty(n)){var i=r[n];$("#post-"+n).length?Post(n)._storeHide():t-i>=window.thread.hideTimeout&&Post(n)._storeUnHide()}}};e.click(function(){var e=$(this).data("num");return Post(e).hide(!0),!1}),$(".hidden-thread-box,.hidden-p-box").live("click",function(){var e=$(this).data("num");Post(e).unhide()});var a=Store.get("board."+window.board+".hidden",{});for(var r in a)if(a.hasOwnProperty(r)&&r!=window.thread.id){var n=Post(r);n.exists()&&n.isRendered()&&n.hide()}return t(),!1}}}),Stage("Скрытие постов по правилам","hiderules",Stage.DOMREADY,function(){if(window.thread.board){var e=Store.get("other.hide_rules.list",[]);if(e.length){var t=Post(1),a=function(e,t){try{return new RegExp(e,"i").test(t)}catch(a){return!1}};$(".post").each(function(){t.num=$(this).data("num");for(var r=0;r<e.length;r++){var n=e[r][0],i=e[r][1],o=e[r][2],s=e[r][3],d=e[r][4],l=e[r][5],c=e[r][6],h=e[r][7],u=!!e[r][8];if(!u&&(!i||t.num==i)&&(!o||a(o,t.cGetIcon()))&&(!s||a(s,t.cGetEmail()))&&(!d||a(d,t.cGetName()))&&(!l||a(l,t.cGetTrip()))&&(!c||a(c,t.cGetSubject()))&&(!h||a(h,t.cGetComment()))){t.hide(!1,"Правило #"+(r+1)+" "+n);break}}})}}}),Stage("Скрытие длинных постов","hidelongpost",Stage.DOMREADY,function(){if(window.thread.board&&!window.thread.id){!function(e){var t=/(\s*\S+|\s)$/;e.truncate=function(t,a){return e("<div></div>").append(t).truncate(a).html()},e.fn.truncate=function(a){e.isNumeric(a)&&(a={length:a});var r=e.extend({},e.truncate.defaults,a);return this.each(function(){var a=e(this);r.noBreaks&&a.find("br").replaceWith(" ");var n=a.text(),i=n.length-r.length;r.stripTags&&a.text(n),r.words&&i>0&&(i=n.length-n.slice(0,r.length).replace(t,"").length-1),0>i||!i&&!r.truncated||e.each(a.contents().get().reverse(),function(t,a){var n=e(a),o=n.text(),s=o.length;return i>=s?(r.truncated=!0,i-=s,void n.remove()):3===a.nodeType?(e(a.splitText(s-i-1)).replaceWith(r.ellipsis),!1):(n.truncate(e.extend(r,{length:s-i})),!1)})})},e.truncate.defaults={stripTags:!1,words:!1,noBreaks:!1,length:1/0,ellipsis:"…"}}(jQuery);var e=150,t=10,a=function(e,t){var a=e.attr("id").substr(1);e.wrapInner('<div id="original-post'+a+'" style="display:none"></div>');var r=$('<div id="shrinked-post'+a+'">'+t+"</div>");e.append(r);var n=$('<span class="expand-large-comment a-link-emulator">Показать текст полностью</span>');r.after(n),n.click(function(){n.remove(),r.remove(),$("#original-post"+a).show()})};$(".post-message").each(function(){for(var r=$(this),n=r.html(),i=0,o=n.split("<br>"),s=0;s<o.length;s++){var d=$("<p>"+o[s]+"</p>").text(),l=Math.ceil((d.length+1)/e);if(!(t>=i+l)){var c=t-i;o[s]=$.truncate(o[s],c*e),o.splice(s+1),a(r,o.join("<br>"));break}i+=l}})}}),Stage("Обработка Media ссылок","mediapeocess",Stage.DOMREADY,function(){if(window.thread.board){var e=$(".post-message a").not(".post-reply-link");Media.processLinks(e)}}),Stage("Коррекция времени по часовому поясу","correcttz",Stage.DOMREADY,function(){if(Store.get("other.correcttz",!0)){var e=60*window.tz_offset*60;if(-(new Date).getTimezoneOffset()/60!=window.tz_offset){var t=["Вск","Пнд","Втр","Срд","Чтв","Птн","Суб"];window.correctTZ=function(a){a=a.replace(/(\d+)\/(\d+)\/(\d+) .+ (\d+:\d+:\d+)/g,"20$3-$2-$1T$4Z"),a=$.trim(a);var r=Date.parse(a);if(!r)return a;r-=1e3*e;var n=new Date(r);return""+pad(n.getDate(),2)+"/"+pad(n.getMonth()+1,2)+"/"+pad(n.getFullYear()-2e3,2)+" "+t[n.getDay()]+" "+pad(n.getHours(),2)+":"+pad(n.getMinutes(),2)+":"+pad(n.getSeconds(),2)},$(".posttime").each(function(){var e=$(this).text();$(this).text(window.correctTZ(e))})}}}),Stage("Обработка формы ответа","formprocess",Stage.DOMREADY,function(){if(window.thread.board){var e="",t=$(".reply-label-top"),a=$(".reply-label-bot"),r=t.first().text(),n="Закрыть форму постинга",i=$("#postform");t.on("click",function(){"bot"==e&&a.text(r),"top"==e?(i.hide(),t.text(r),e=""):($("#TopNormalReply").after(i),i.show(),t.text(n),e="top",window.thread.id||$("input[name=thread]").val(0))}),a.on("click",function(){"top"==e&&t.text(r),"bot"==e?(i.hide(),a.text(r),e=""):($("#BottomNormalReply").after(i),i.show(),a.text(n),e="bot",window.thread.id||$("input[name=thread]").val(0))}),window.appendPostForm=function(n){if("top"==e&&t.text(r),"bot"==e&&a.text(r),e!=n){var o=Post(n);o.el().after(i),i.show(),window.thread.id||$("input[name=thread]").val(o.getThread()),$(".captcha-image:first").html()||loadCaptcha()}}}}),Stage("Загрузка автообновления","autorefresh",Stage.DOMREADY,function(){if(window.thread.board){var e,t,a,r=!1,n=!0,i=[];window.scrollcb_array.push(function(e){if(i.length){for(var t=e+$(window).height(),a=0;a<i.length;a++)t>=i[a][1]&&(i.splice(a,1),a--);l(),i.length||s()}}),$(window).blur(function(){n=!1,s()}),$(window).focus(function(){n=!0,i.length&&$(window).scroll(),$(".autorefresh-checkbox").is(":checked")&&a>window.config.autoUpdate.minInterval&&f(window.config.autoUpdate.minInterval)});var o,s=function(){var e=$(".new-posts-marker");e.length&&e.removeClass("new-posts-marker"),i.length&&$("#post-"+i[0]).prev().addClass("new-posts-marker")},d=function(e){e!=o&&o!=window.config.autoUpdate.faviconDeleted&&(o=e,$("#favicon").replaceWith(e))},l=function(){var e=i.length;e?(document.title="("+e+") "+window.config.title,d(window.config.autoUpdate.faviconNewposts)):(document.title=window.config.title,d(window.config.autoUpdate.faviconDefault))},c=function(){d(window.config.autoUpdate.faviconDeleted),$(".autorefresh-countdown").html(" остановлено")},h=window.autorefresh_start=function(){return r?!1:(r=!0,$(".autorefresh-checkbox").attr("checked","checked"),e=setInterval(function(){var e=$(".autorefresh-countdown");a--,a>=0&&e.html("через "+a),0==a&&(e.html(" выполняется..."),updatePosts(function(e){if(e.error){if("server"==e.error&&-404==e.errorCode)return c();$alert("Ошибка автообновления: "+e.errorText),
p(-1)}else{if(e.updated){for(var t=e.list.length,a=0;t>a;a++){var r=$("#post-"+e.list[a]);i.push([e.list[a],r.offset().top+r.height()])}l(),s()}p(e.updated),Favorites.isFavorited(window.thread.id)&&Favorites.setLastPost(e.data,window.thread.id)}}))},1e3),void f(window.config.autoUpdate.minInterval))},u=function(){return r?(r=!1,$(".autorefresh-checkbox").removeAttr("checked"),clearInterval(e),void $(".autorefresh-countdown").html("")):!1},p=function(e){if(e>1)return f(window.config.autoUpdate.minInterval);if(n&&-1!=e)return f(window.config.autoUpdate.minInterval);var a=t+window.config.autoUpdate.stepInterval;return f(a>window.config.autoUpdate.maxInterval?window.config.autoUpdate.maxInterval:a)},f=function(e){a=e,t=e,$(".autorefresh-countdown").html("через "+a)};$(".autorefresh-checkbox").click(function(){var e=$(this).is(":checked");e?h():u(),Store.set("thread.autorefresh",!!e)}),$(".autorefresh").css("display","inline-block")}}),Stage("Клонирование форм","cloneform",Stage.DOMREADY,function(){if(window.thread.board){for(var e=["e-mail","shampoo","captcha-value"],t=parseInt($("#settings-comment-length").val()),a=e.length,r=function(e){var a=unescape(encodeURIComponent(e)).length,r=t-a;0>r&&(r=0),$(".message-byte-len").html(r)},n=0;a>n;n++){var i=e[n];!function(e){$("#"+e).keyup(function(){var t=$("#"+e).val();$("#qr-"+e).val(t),"shampoo"==e&&r(t)}),$("#qr-"+e).keyup(function(){var t=$("#qr-"+e).val();$("#"+e).val(t),"shampoo"==e&&r(t)})}(i)}$(".anoniconsselectlist").change(function(){var e=$(this).val();$(".anoniconsselectlist").val(e)})}}),Stage("Отслеживание фокуса форм","formfocus",Stage.DOMREADY,function(){window.thread.board&&(window.activeForm=$("#shampoo"),window.activeForm.focus(function(){window.activeForm=$(this)}),$("#qr-shampoo").focus(function(){window.activeForm=$(this)}))}),Stage("click эвенты","clickevents",Stage.DOMREADY,function(){if(window.thread.board){var e="",t=0;$(".captcha-reload-button").click(loadCaptcha),$(".post").live("mouseup",function(a){if(1==a.which){var r,n=$(this).data("num");try{r=window.getSelection?window.getSelection().focusNode.parentNode:document.selection.createRange().parentElement()}catch(a){return}if($(r).closest(".post").data("num")==n){var i="";if(window.getSelection?i=window.getSelection().toString():document.selection&&"Control"!=document.selection.type&&(i=document.selection.createRange().text),i+="",!i)return t=0,void(e="");e=i,t=n,e=">"+e.split("\n").join("\n>")}}}),$(".reply-label").click(function(){$(".captcha-image:first").html()||loadCaptcha()}),$("#ed-toolbar").html(edToolbar("shampoo")),$("#qr-close").click(function(){$("#qr").hide()}),$(".postbtn-reply-href").live("click",function(){var a=$(this).attr("name"),r=">>"+a+"\n";if(t==a&&(r+=e+"\n",t=0),insert(r),Store.get("old.append_postform",!1)&&appendPostForm(a),window.thread.id)return!1;var n=Post(a).getThread();return $("#qr-thread").val(n),!1})}}),Stage("Превью постов","postpreview",Stage.DOMREADY,function(){if(window.thread.board){var e,t=function(t){if(e=t.relatedTarget){for(;;){if(/^preview/.test(e.id))break;if(e=e.parentNode,!e)break}setTimeout(function(){if(e)for(;e.nextSibling;)$del(e.nextSibling);else $each($t("div"),function(e){/^preview/.test(e.id)&&$del(e)})},Store.get("other.hide_post_preview_delay",800))}},a=function(t){e&&(e.innerHTML=t)},r=function(r,n,i){var o=r.target,s=document.body.clientWidth||document.documentElement.clientWidth,d=window.innerHeight||document.documentElement.clientHeight;x=$offset(o,"offsetLeft")+o.offsetWidth/2,y=$offset(o,"offsetTop"),r.clientY<.75*d&&(y+=o.offsetHeight),e=$new("div",{id:"preview-"+n,"data-num":n,"class":"reply post",html:'<span class="ABU-icn-wait">&nbsp;</span>&nbsp;Загрузка...',style:"position:absolute; z-index:300; border:1px solid grey; "+(x<s/2?"left:"+x:"right:"+parseInt(s-x+2))+"px; "+(r.clientY<.75*d?"top:"+y:"bottom:"+parseInt(d-y-4))+"px"},{mouseout:t,mouseover:function(){e||(e=this)}});var l=Post(n);if(!l.exists()||l.isGhost()?l.download(function(e){return e.errorText?a("Ошибка: "+e.errorText):(a(l.previewHTML()),void(l.isRendered()||Media.processLinks($("#m"+n+" a"))))}):a(l.previewHTML()),$del($id(e.id)),dForm.appendChild(e),l.isRendered()){var c=$("#preview-"+n);c.find(".media-expand-button").remove(),Media.processLinks(c.find("a"))}else Media.processLinks($("#m"+n+" a"))},n={},i=function(e){n.hasOwnProperty(e)&&(clearTimeout(n[e]),delete n[e])},o=Store.get("other.show_post_preview_delay",50);$(".post-reply-link").live("mouseover",function(e){var t=$(this),a=t.data("num"),s=t.data("thread");o?n[a]=setTimeout(function(){i(a),r(e,a,s)},o):r(e,a,s)}).live("mouseout",function(e){var a=$(this),r=a.data("num");i(r),t(e)}).live("click",function(){var e=$(this),t=e.data("num");Post(t).highlight()})}}),Stage("Опции постов","postoptions",Stage.DOMREADY,function(){if(window.thread.board){var e=0,t=function(e){var t=window.location.host,a="http://www.google.com/searchbyimage?image_url=";return a+"http://"+t+e.attr("href")},a=function(e,a){var r=Post(a),i=$("#post-body-"+a+" .image .desktop"),o=$('<a href="#">Ответить</a>');o.click(function(){return $(document.getElementsByName(a)).click(),!1}),e.append(o);var s=$('<a href="#">Скрыть</a>');if(s.click(function(){return Post(a).hide(!0),n(),!1}),e.append(s),window.thread.id){var d=$('<a href="#">Пожаловаться</a>');d.click(function(){var e=$("#report-form-comment");return e.val(">>"+a+" "+e.val()),n(),e.focus(),!1}),e.append(d)}if(1==i.length?e.append('<a href="'+t(i)+'" target="_blank">Найти картинку</a>'):i.length>1&&i.each(function(a){var r=$(this);e.append('<a href="'+t(r)+'" target="_blank">Найти картинку '+(a+1)+"</a>")}),r.isThread()){var l="В избранное",c=Favorites.isFavorited(a);c&&(l="Из избранного");var h=$('<a href="#">'+l+"</a>");h.click(function(){return c?Favorites.remove(a):(Favorites.add(a),Favorites.show(),Favorites._send_fav(a)),n(),!1}),e.append(h)}},r=function(e){var t={},a=e.offset();return t.left=a.left+e.outerWidth()+"px",t.top=a.top+"px",t},n=function(){e&&(e=0,$("#ABU-select").remove())};$("body").click(n),$(".postbtn-options").live("click",function(){var t=$(this),i=t.data("num"),o=e;if(n(),e=i,o==i)return e=0,!1;var s=$("<span></span>");s.attr("id","ABU-select"),s.attr("class","reply"),s.css(r(t)),a(s,i),s.click(n),$("body").append(s)})}}),Stage("Система раскрытия на полный экран","screenexpand",Stage.DOMREADY,function(){var e,t,a=$('<div style="position: fixed;display: none;background-color: #555555;padding:8px;-webkit-box-sizing: content-box;-moz-box-sizing: content-box;box-sizing: content-box;" id="fullscreen-container"></div>'),r=$(window),n=!1,i=!1,o=1,s=0,d=0,l=!1,c=8;$("body").append(a),window.fullscreenExpand=function(s,d,p,f,m){if(abortWebmDownload(),n==s)return h(),!1;var v=r.width(),w=r.height();if(e=f,t=m,o=1,n=s,l=".webm"==d.substr(-5),i=!1,a.html(l?'<video id="html5video" onplay="webmPlayStarted(this)" onvolumechange="webmVolumeChanged(this)" name="media" loop="1" '+(Store.get("other.webm_vol",!1)?"":'muted="1"')+' controls="" autoplay="" height="100%" width="100%"><source class="video" height="100%" width="100%" type="video/webm" src="'+d+'"></source></video>':'<img src="'+d+'" width="100%" height="100%" />').css("top",(w-m)/2-c+"px").css("left",(v-f)/2-c+"px").width(f).height(m).show(),f>v||m>w){var g=Math.floor(v/f*10)/10,b=Math.floor(w/m*10)/10;.1>g&&(g=.1),.1>b&&(b=.1),u(b>g?g:b,!0)}return!1};var h=function(){abortWebmDownload(),n=!1,i=!1,a.hide(),l&&a.html("")},u=function(r,n){.1>r||r>5||(p(r,n),o=r,a.width(e*o).height(t*o))},p=function(n,i){var l,c,h=r.scrollTop(),u=r.scrollLeft(),p=a.offset();i?(l=e/2,c=t/2):(l=s-p.left+u,c=d-p.top+h);var f=p.top-h,m=p.left-u,v=n-o,w=v*c/o,g=v*l/o;a.css("left",m-g+"px").css("top",f-w+"px")};a.mouseover(function(){i=!0}),a.mouseout(function(){i=!1}),a.mousemove(function(e){s=e.clientX,d=e.clientY}),r.keyup(function(e){if(n){var t,a=e.keyCode||e.which;if(37==a||65==a||97==a||1092==a)t=-1;else{if(39!=a&&68!=a&&100!=a&&1074!=a)return 27==a?h():void 0;t=1}var r=$(".image-link"),i=r.index($("#exlink-"+n)),o=i+t;0>o&&(o=r.length-1),o>r.length-1&&(o=0);var s=r.eq(o);s.find("a").click()}}),r.click(function(e){n&&1==e.which&&($(e.target).closest(".img").length||"expandfunc"!=$(e.target).attr("name")&&($(e.target).closest("#fullscreen-container").length||h()))}),r.bind(/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel",function(e){if(n&&i){e.preventDefault();var t=window.event||e;t=t.originalEvent?t.originalEvent:t;var a=t.detail?-40*t.detail:t.wheelDelta;u(a>0?o+.1:o-.1)}}),draggable(a,{click:function(){h()},mousedown:function(e,t){if(l){var r=parseInt(a.css("top")),n=a.height();return 35>r+n-t?!1:void 0}}})}),Stage("renderStore","renderstore",Stage.DOMREADY,function(){window.thread.board&&(renderStore(),Store.get("styling.disable_bytelen_counter",!1)&&$(".message-byte-len").hide(),Store.get("styling.portform_format_panel",!1)&&($(".toolbar-area").css("display","table-row"),$("#CommentToolbar").html(edToolbar("shampoo")),$("#qr-CommentToolbar").html(edToolbar("qr-shampoo"))))}),Stage("Кнопки перемотки страницы","scrollbtns",Stage.DOMREADY,function(){if(window.thread.board&&Store.get("other.scroll_btns",!1)){var e=300,t=$("#up-nav-arrow"),a=$("#down-nav-arrow"),r=!1,n=!1,i=function(){r||(r=!0,t.css("opacity",1))},o=function(){r&&(r=!1,t.css("opacity",0))},s=function(){n||(n=!0,a.css("opacity",1))},d=function(){n&&(n=!1,a.css("opacity",0))};window.scrollcb_array.push(function(t){if(!(t>e))return o(),void s();i();var a=$(document).height()-$(window).height(),r=a-t;r>e?s():(d(),i())}),t.click(function(){$(window).scrollTop(0).scroll()}),a.click(function(){$(window).scrollTop($(document).height()).scroll()}),s()}}),Stage("Избранное","favorites",Stage.DOMREADY,function(){var e=$("#qr-fav-body"),t=Store.get("favorites");for(var a in t)if(t.hasOwnProperty(a)){var r=t[a];if("object"==typeof r&&r.hasOwnProperty("last_post")){var n=Favorites.render_get_html(a,r);e.append(n)}}$("#qr-fav-close").click(function(){Favorites.hide()}),$("#fav-menu-btn").click(function(){Favorites.visible?Favorites.hide():Favorites.show()}),Favorites.init(),$(".fav-row-remove").live("click",function(){var e=$(this).data("num");confirm("Вы уверены?")&&Favorites.remove(e)}),$(".fav-row-update").live("click",function(){var e=$(this).data("num");Favorites.forceRefresh(e)}),Store.get("styling.qr-fav.visible",!1)&&Favorites.render_show(),$(".postbtn-favorite,#postbtn-favorite-bottom").click(function(){var e=$(this).data("num")||window.thread.id,t=Favorites.isFavorited(e);t?Favorites.remove(e):(Favorites.add(e),Favorites.render_show(),Favorites._send_fav(e))}),Store.get("other.fav_stats",!1)&&$(".loice-bar").css("display","inline-block")}),Stage("Загрузка плавающих окон","qrload",Stage.DOMREADY,function(){draggable_qr("qr","left"),draggable_qr("qr-fav","center"),draggable_qr("settings-window","center"),draggable_qr("setting-editor-window","center")}),Stage("Юзеропции","settings",Stage.DOMREADY,function(){if(Settings.addCategory("favorites","Избранное"),Settings.addCategory("old","Раньшебылолучше"),Settings.addCategory("other","Другое"),Settings.addCategory("mobile","Мобильная версия"),Settings.addCategory("hide","Скрытие"),Settings.addSetting("favorites","favorites.show_on_new",{label:"Показывать избранное при новом сообщении","default":!0}),Settings.addSetting("favorites","favorites.deleted_behavior",{label:"При удалении треда на сервере",multi:!0,values:[["0","Не удалять из избранного"],["1","Повторно проверять перед удалением"],["2","Удалять из избранного сразу"]],"default":1}),Settings.addSetting("old","styling.qr.disable_if_postform",{label:"Не выводить плавающую форму если развёрнута другая форма","default":!1}),Settings.addSetting("old","styling.qr.disable",{label:"Не выводить плавающую форму при клике на номер поста","default":!1}),Settings.addSetting("old","styling.disable_bytelen_counter",{label:"Не показывать счётчик байт в форме постинга","default":!1}),Settings.addSetting("old","styling.portform_format_panel",{label:"Показ панели разметки текста в форме","default":!1}),Settings.addSetting("old","old.append_postform",{label:"Показ формы постинга под постом при ответе","default":!1}),Settings.addSetting("old","old.ctrl_enter_submit",{label:"Отправка поста по Ctrl+Enter","default":!0}),Settings.addSetting("old","old.media_thumbnails",{label:"Показ превью видео","default":!0}),Settings.addSetting("old","old.media_thumbnails_on_hover",{label:"Показ превью видео только при наводе мыши на ссылку","default":!0}),Settings.addSetting("old","other.fullscreen_expand",{label:"Разворачивать картинки в центре экрана","default":!0}),Settings.addSetting("other","other.on_reply_from_main",{label:"При ответе с главной в тред",multi:!0,values:[["0","Ничего не делать"],["1","Перенаправлять в тред"],["2","Разворачивать тред"]],"default":1}),Settings.addSetting("other","other.qr_close_on_send",{label:"Закрывать плавающую форму после ответа","default":!0}),Settings.addSetting("other","other.custom_css.enabled",{label:"Пользовательский CSS","default":!1,edit:{label:"Редактировать",title:"Редактировать СSS",editor:"textarea",path:"other.custom_css.data",saveable:!0,"default":""}}),Settings.addSetting("other","other.show_post_preview_delay",{label:"Задержка показа ответа при наводе мыши на номер поста",multi:!0,values:[["0","Нет"],["50","50мс"],["100","100мс"],["200","200мс"],["300","300мс"],["400","400мс"],["500","500мс"]],"default":50}),Settings.addSetting("other","other.hide_post_preview_delay",{label:"Задержка скрытия ответа",multi:!0,values:[["0","Нет"],["50","50мс"],["100","100мс"],["200","200мс"],["500","500мс"],["800","800мс"],["1000","1000мс"],["1500","1500мс"],["2000","2000мс"],["3000","3000мс"],["5000","5000мс"]],"default":800}),Settings.addSetting("other","other.expand_autoscroll",{label:"При сворачивании длинной пикчи фокусироваться на пост","default":!0}),Settings.addSetting("other","other.scroll_btns",{label:"Показ кнопок перемотки страницы","default":!1}),Settings.addSetting("other","other.qr_hotkey",{label:"Выводить плавающую форму по Ctrl+Space","default":!0}),Settings.addSetting("other","other.boardstats",{label:"Показывать топ тредов","default":!0}),Settings.addSetting("other","other.fav_stats",{label:"Показывать количество подписок на треды","default":!1}),Settings.addSetting("other","other.myboards.enabled",{label:"Показывать Мои доски","default":!0}),Settings.addSetting("other","other.myboards.menu",{label:"Заменить меню разделов на Мои доски","default":!1}),Settings.addSetting("other","other.correcttz",{label:"Коррекция часового пояса","default":!0}),Settings.addSetting("other","other.captcha_provider",{label:"Капча",multi:!0,values:[["google","Google"],["yandex","Yandex"]],"default":"yandex"}),Settings.addSetting("mobile","mobile.dont_expand_images",{label:"Открывать пикчи в новом окне","default":!0}),Settings.addSetting("mobile","mobile.hide_qr",{label:"Отключить плавающую форму","default":!0}),Settings.addSetting("hide","other.hide_rules.enabled",{label:"Правила скрытия постов","default":!1,edit:{label:"Редактировать",title:"Редактировать правила скрытия",editor:"hiderules",path:"other.hide_rules.list",importable:!0,"default":[]}}),Store.get("debug")){Settings.addCategory("debugdtages","[debug] отключение стадий");for(var e=[["Загрузка Media провайдеров","media"],["Загрузка стиля","styleload"],["Переключение разделов на мобилках","boardswitch"],["Переключение стилей","styleswitch"],["Статистика тредов","threadstats"],["Обработка нажатий клавиш","keypress"],["Обработка скрытия тредов и постов","posthide"],["Скрытие постов по правилам","hiderules"],["Скрытие длинных ОП-постов","hidelongpost"],["Обработка и отправка постов на сервер","postsumbit"],["Enable debug","enabledebug"],["NSFW","nsfw"],["Коррекция времени по часовому поясу","correcttz"],["Обработка Media ссылок","mediapeocess"],["DEBUG Обратная совместимость ответов","wakabareply"],["Наполнение карты постов","mapfill"],["Обработка формы ответа","formprocess"],["Загрузка автообновления","autorefresh"],["Клонирование форм","cloneform"],["Управление полями загрузки картинок","uploadfields"],["Отслеживание фокуса форм","formfocus"],["click эвенты","clickevents"],["Превью постов","postpreview"],["Опции постов","postoptions"],["renderStore","renderstore"],["Кнопки перемотки страницы","scrollbtns"],["Избранное","favorites"],["Загрузка плавающих окон","qrload"],["Мои доски","myboards"],["Подсветка якоря","ancorlight"]],t=0;t<e.length;t++){var a=e[t][0],r=e[t][1];Settings.addSetting("debugdtages","debug_disable_stage."+r,{label:"Отключить ["+a+"]","default":!1})}}Settings.addEditor("textarea",function(e){var t=$("#setting-editor-body"),a=$('<textarea id="setting-editor-textarea-textarea"></textarea>');a.val(e),t.append(a)},function(){return $("#setting-editor-textarea-textarea").val()}),Settings.addEditor("singleinput",function(e){var t=$("#setting-editor-body"),a=$('<span id="setting-editor-singleinput-text">Укажите список разделов через запятую.<br>Приммер: b,fag,po<br></span><input type="text" id="setting-editor-singleinput-input" />');a.val(e),t.append(a)},function(){return $("#setting-editor-singleinput-input").val()});var n=[];Settings.addEditor("hiderules",function(e){var t=0,a=function(e,a,r,n,s,d,l,c,h){var u='<span class="hiderules-table-empty-cell">.*</span>';i.append('<tr id="hiderules-table-row'+o+'" class="'+(h?"hiderules-table-row-disabled":"")+'"><td>№'+t+"</td><td>"+(escapeHTML(e)||"")+"</td><td>"+(escapeHTML(a)||u)+"</td><td>"+(escapeHTML(r)||u)+"</td><td>"+(escapeHTML(n)||u)+"</td><td>"+(escapeHTML(s)||u)+"</td><td>"+(escapeHTML(d)||u)+"</td><td>"+(escapeHTML(l)||u)+"</td><td>"+(escapeHTML(c)||u)+'</td><td><input type="button" value="Экспорт" class="hiderules-table-row-export-btn" data-num="'+o+'"><input type="button" value="Удалить" class="hiderules-table-row-delete-btn" data-num="'+o+'"></td></tr>')},r=$("#setting-editor-body"),i=$('<table id="hiderules-table" class="hiderules-table"><thead><tr id="hiderules-table-header"><td>№</td><td>Название</td><td>#треда</td><td>Иконка</td><td>Email</td><td>Имя/ID</td><td>Трипкод</td><td>Тема</td><td>Сообщение</td><td>Управление</td></tr></thead></table>');n=e,r.html("");for(var o=0;o<n.length;o++){t=o+1;n[o][0],n[o][1],n[o][2],n[o][3],n[o][4],n[o][5],n[o][6],n[o][7],!!n[o][8];a.apply(this,n[o])}i.append('<tr id="hiderules-add-form"><td class="hiderules-add-row">№'+(o+1)+'</td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-title"    class="hiderules-add-input error"></td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-tnum"     class="hiderules-add-input"></td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-icon"     class="hiderules-add-input" placeholder=".*"></td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-email"    class="hiderules-add-input" placeholder=".*"></td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-name"     class="hiderules-add-input" placeholder=".*"></td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-trip"     class="hiderules-add-input" placeholder=".*"></td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-subject"  class="hiderules-add-input" placeholder=".*"></td><td class="hiderules-add-row"><input type="text" id="hiderules-add-input-comment"  class="hiderules-add-input" placeholder=".*"></td><td><input id="hiderules-add-submit-btn" type="button" value="Добавить" disabled="disabled"></td></tr>');var s=$('<div id="hiderules-add-form"><div class="hiderules-add-row"><span class="hiderules-add-label">Правило:</span>  <input type="text" id="hiderules-add-json-input" placeholder="Можно вставить сохранённое ранее"></div>В полях указываются регулярные выражения.<br>Для конвертации строк в регулярки используйте конвертер:<br><input type="text" id="hiderules-add-converter-str"> -> <input type="text" id="hiderules-add-converter-regex" readonly="readonly"><br></div>');r.append(i),r.append(s),r.append('<div id="hiderules-bottom">Нижние кнопки импорта и экспорта импортируют/экспортируют ВСЕ правила</div>'),$(".hiderules-table-row-export-btn").click(function(){var e=$(this).data("num"),t=Store.get("other.hide_rules.list."+e);prompt("Скопируйте",JSON.stringify(t))}),$(".hiderules-table-row-delete-btn").click(function(){var e=$(this).data("num"),t=Store.get("other.hide_rules.list");t.splice(e,1),Store.set("other.hide_rules.list",t),Settings._editor_show(t)}),$("#hiderules-add-converter-str").keyup(function(){var e=$.trim($(this).val()),t=String(e).replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&");$("#hiderules-add-converter-regex").val(t)});var d=function(){for(var e=!1,t=0;t<l.length;t++){var a=l[t][0],r=l[t][1];if("title"!=a)try{new RegExp(r.val()),r.removeClass("error")}catch(n){r.addClass("error")}else{if(r.val()){r.removeClass("error");continue}e=!0,r.addClass("error")}}return e},l=[];l.push(["title",$("#hiderules-add-input-title")]),l.push(["tnum",$("#hiderules-add-input-tnum")]),l.push(["icon",$("#hiderules-add-input-icon")]),l.push(["email",$("#hiderules-add-input-email")]),l.push(["name",$("#hiderules-add-input-name")]),l.push(["trip",$("#hiderules-add-input-trip")]),l.push(["subject",$("#hiderules-add-input-subject")]),l.push(["comment",$("#hiderules-add-input-comment")]);var c=$("#hiderules-add-submit-btn"),h=$("#hiderules-add-json-input");$(".hiderules-add-input").keyup(function(){for(var e=[],t=0;t<l.length;t++)e.push(l[t][1].val());h.val(JSON.stringify(e)),d()?c.attr("disabled","disabled"):c.removeAttr("disabled","disabled"),h.removeClass("error")}).focus(function(){$(this).attr("size","25")}).blur(function(){$(this).removeAttr("size")}),$(h).keyup(function(){var e;try{e=JSON.parse(h.val())}catch(t){return void h.addClass("error")}if(!e.length||8!=e.length&&9!=e.length)return void h.addClass("error");for(var a=0;8>a;a++)l[a][1].val(e[a]);h.removeClass("error"),d()}),$(c).click(function(){for(var e=[],a=0;a<l.length;a++)e.push($.trim(l[a][1].val()));var r=Store.get("other.hide_rules.list",[]);r.push(e),Store.set("other.hide_rules.list",r),t++,Settings._editor_show(r)})},function(){}),$("#settings").click(function(){Settings.toggle()}),$("#settings-btn-close").click(function(){Settings.hide()}),$("#settings-btn-export").click(function(){prompt("Скопируйте и сохраните",Store["export"]())}),$("#settings-btn-import").click(function(){var e=prompt("Вставьте сохранённые настройки");if(e){try{JSON.parse(e)}catch(t){return $alert("Неверный формат")}localStorage.store=e,Store.reload(),Settings.hide(),$alert("Для применения настроек обновите страницу")}}),$("#settings-btn-save").click(function(){var e=[];$(".settings-setting-checkbox").each(function(){var t=$(this),a=t.data("category"),r=t.data("path"),n=Settings.getSetting(a,r),i=Store.get(r,n["default"]),o=t.is(":checked");i!=o&&(e.push(r),o==n["default"]?Store.del(r):Store.set(r,o))}),$(".settings-setting-multibox").each(function(){var t=$(this),a=t.data("category"),r=t.data("path"),n=Settings.getSetting(a,r),i=Store.get(r,n["default"]),o=t.val();i!=o&&(e.push(r),o==n["default"]?Store.del(r):Store.set(r,o))}),e.length&&$alert("Для применения настроек обновите страницу"),Settings.hide()}),$("#setting-editor-btn-save").click(function(){var e=Settings._editor_onsave();e==Settings._editor_default_val?Store.del(Settings._editor_path):Store.set(Settings._editor_path,e),$("#setting-editor-window").hide()}),$("#setting-editor-btn-close").click(function(){$("#setting-editor-window").hide()}),$("#setting-editor-btn-export").click(function(){prompt("Скопируйте и сохраните",JSON.stringify(Store.get(Settings._editor_path,{})))}),$("#setting-editor-btn-import").click(function(){var e,t=prompt("Вставьте сохранённое");if(t){try{e=JSON.parse(t)}catch(a){return $alert("Неверный формат")}Store.set(Settings._editor_path,e),$("#setting-editor-window").hide()}})}),Stage("Подсветка якоря","ancorlight",Stage.DOMREADY,function(){if(window.thread.board){var e;if(e=/#([0-9]+)/.exec(document.location.toString())){var t=Post(e[1]);if(!t.exists()||!t.isRendered())return;Post(e[1]).highlight(),scrollToPost(e[1]),history.pushState("",document.title,window.location.pathname)}}}),Stage("Предупреждение о анальной цензуре","censure",Stage.DOMREADY,function(){var e=0,t=setInterval(function(){$("#de-panel").length&&!$(".jcaptcha").length&&+new Date-Store.get("tmp.censure",0)>108e5&&($alert('У вас установлен куклоскрипт, который без вашего ведома может удалять треды из выдачи и премодерировать информацию. Рекомендуем избавиться от него.<a href="https://twitter.com/abunyasha/status/520708815038451712" target="_blank">Подробнее</a><br><a href="#" id="censure-notice-close">Закрыть</a>',"wait"),$("#censure-notice-close").click(function(e){e.preventDefault(),$close($id("ABU-alert-wait")),Store.set("tmp.censure",+new Date)}),clearInterval(t)),e++,e>=10&&clearInterval(t)},1e3)});var widgetMain,widgetQr;